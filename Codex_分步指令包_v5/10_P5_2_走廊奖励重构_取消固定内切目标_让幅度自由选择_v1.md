# 10_P5.2 走廊奖励重构：取消固定内切目标（e_target），让幅度自由选择_v1
> 前置条件：P5.1 已通过（LOS turn 指标与出弯事件对齐）。  
> 本阶段目标：把 corridor 从“跟踪一条偏置参考线”改成“在可行走廊内做速度-误差折中”，让策略能**自选内切幅度**，并通过 P5.1 的 LOS turn→cap 链路获得速度收益。

---

## 目标（Scope）
1) 移除走廊内的固定目标 `e_target` 跟踪项 `|e_n - e_target|`（或把它降到可忽略）  
2) 走廊内 shaping 改为“边界势垒（安全裕度）+ 轻微误差偏好（可选）”  
3) 保持 corridor 可开关、corridor_status 可观测（用于你调试符号与边界）
4) 不改变 done 判据与 P4 的速度结构（只重塑 corridor 的“幅度自由度”）

---

## 允许改动的文件
- `src/environment/cnc_env.py`
- `src/environment/reward.py`（若 corridor reward 在此）
- 新增：`tools/p5_corridor_amplitude_report.py`（必做）

## 禁止改动（本阶段不要碰）
- LOS turn/kappa/corner_phase（P5.1 刚做完，不要再动）
- turning-feasible cap 的“可控性边界升级”（P6.0 才做）
- 动作量纲映射（P5.0 已锁定）

---

## 任务 1：走廊定义保持不变，但奖励形状替换（必须）
你已有 corridor：左转在 `e_n>0` 内侧，右转在 `e_n<0` 内侧。保持这一点不变。  
本阶段只改“走廊内 reward 形状”。

### 1.1 定义安全裕度（margin_to_edge）
- `lower, upper` 为走廊边界（同 e_n 符号约定）
- `m = min(e_n - lower, upper - e_n)` （到最近边界的距离）
- 在走廊内：`m >= 0`；越界：`m < 0`

### 1.2 走廊内 reward（强制：不再追 e_target）
使用“势垒/斥力”而不是“定点跟踪”：
- 在走廊内：当 `m` 大（离边界远）惩罚接近 0；当 `m` 小（贴边）惩罚迅速增大  
  例：`r_safe = -w_safe * softplus((m_safe - m)/s)`  
  - `m_safe` 是你想保留的安全裕度（如 0.2*half_epsilon）
  - `s` 控制陡峭程度

可选（但不允许变回固定幅度）：
- 仅施加轻微中心偏好：`r_center = -w_center * (|e_n|/half_epsilon)^p`，建议 `w_center` 很小（用于避免“永远贴边蹭速”）

### 1.3 越界惩罚保持连续（必须）
- 走廊外：按到区间距离二次惩罚（连续）
- 若你已有越界终止/重惩罚逻辑，保持即可

---

## 任务 2：corridor_status 扩展（必做）
保持已有字段，并新增两个用于你判断“是不是在自由探索”：
- `margin_to_edge = m`
- `barrier_penalty`（或 r_safe 的数值）

---

## 任务 3：新增 tools/p5_corridor_amplitude_report.py（必做）
目的：用数据证明“幅度不再被固定”。

建议流程：
1) 用 square 跑 E=20 episode（可用当前 best_model 或随机策略也行，最好两者都跑）
2) 在拐角段（corner_phase=True）收集 `e_n` 样本
3) 输出：
- `e_n` 的直方/分位数（p10/p50/p90）
- 与 P5.1 的 `alpha/kappa_los/v_ratio_cap` 的相关性（至少打印 corr 或者分桶均值）

验收要点：
- 不允许 `e_n` 在拐角段收敛成一个极窄尖峰（那就是固定幅度）
- `e_n` 的分布要能解释：更内切（|e_n|大一些）时，LOS 的 `kappa_los` 统计上更小/`v_ratio_cap` 更大（方向以你的符号为准，但必须“幅度能影响速度上限”）

---

## 自验证/验收标准（你将这样验证）
1) **幅度自由（硬指标）**  
   - 运行 `tools/p5_corridor_amplitude_report.py`  
   - **验收：** corner_phase 内 `e_n` 分布不再是单点尖峰；至少 p10-p90 有明显跨度

2) **越界率不恶化（硬指标）**  
   - quick_eval：line/square/s_shape 各 E=20  
   - **验收：** oob_rate 不显著上升；success_rate 不显著下降

3) **速度-误差权衡开始出现（期望指标）**  
   - 你应能观察到：拐角段 `v_mean` 上升或 `steps_mean` 下降，同时 rmse 不爆炸  
   - 这为 P6.0 的“可控性边界刹车”打基础

---

## 交付物（提交时必须包含）
1) 改动文件列表 + corridor reward 新公式说明（明确：不再追 e_target）  
2) `tools/p5_corridor_amplitude_report.py` + 输出样例  
3) quick_eval 输出样例（E=20，line/square/s_shape）
