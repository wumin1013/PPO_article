# 12_P6.1 快又顺：抑制抖动（动作变化率惩罚）+ 目标速度平滑器（更像顶级数控的 S-curve）_v1
> 前置条件：P6.0 已通过（可控性边界 cap 能提前、平顺地下压速度）。  
> 本阶段目标：在不牺牲 success 的前提下，把“快”变成“快而稳、快而顺”：  
> - 减少策略输出的抖动（chattering）导致的 KCM 频繁干预  
> - 让速度目标变化更像数控的加减速规划（S-curve-ish）：连续、可控、低 jerk  
> - 保持你想要的：直线快、弯前降速、出弯快、可靠到终点

---

## 目标（Scope）
1) 添加“动作变化率惩罚”（policy 层面）：惩罚 `Δu`，但不能把速度压成龟速  
2) 添加“目标速度平滑器”（env 层面）：`v_target` 的变化受限（dv/dt、dv/dt 的变化）  
3) 输出平顺性指标：`kcm_intervention`、`jerk/angular_jerk`、`|Δu|` 的统计，形成可量化验收

---

## 允许改动的文件
- `src/environment/cnc_env.py`
- `src/environment/reward.py`
- 新增：`tools/p6_smoothness_report.py`（必做）

## 禁止改动（本阶段不要碰）
- P6.0 的 cap 公式（不要再动可控性边界）
- corridor reward 形状（P5.2 已锁定）
- done 判据/终点逻辑

---

## 任务 1：动作变化率惩罚（必须，小权重）
在 reward 中加入（建议只在 corner_phase 或全程都可，但要小心别压死速度）：
- `r_du = -w_du * (|Δtheta_u| + |Δv_u|)` 或平方版
- `Δu = u_t - u_{t-1}`（使用 action_policy 的比率动作）
建议初值：
- `w_du = 0.005 ~ 0.02`（必须很小）
- 并输出 `mean(|Δu|)` 作为监控指标

> 原则：这是“抑制抖动”，不是“限制速度”。权重太大会把策略训练成慢吞吞的平滑。

---

## 任务 2：目标速度平滑器（必须，env 内实现）
你目前的执行链是：`policy v_u` → cap → KCM（MAX_ACC/MAX_JERK）→ 执行。  
现实 CNC 常见还有一层：**目标速度本身也不允许乱跳**。本阶段加入一个简单但有效的“v_target 规划器”：

### 2.1 设计
- 输入：`v_des = v_u_exec * MAX_VEL`（已包含 cap）
- 输出：`v_target`（送入 KCM 的 raw_linear_vel_intent）

实现一个一阶/二阶限幅器（二选一，优先 B）：

A) 一阶低通（最简单）
- `v_target = v_target_prev + beta*(v_des - v_target_prev)`
- `beta = dt / (tau + dt)`，建议 `tau=0.05~0.15s`

B) “加速度限幅的目标器”（推荐，更像规划）
- 限制目标变化：`|v_target - v_target_prev| <= a_ref_max * dt`
- 其中 `a_ref_max` 建议小于 `MAX_ACC`（例如 0.3~0.6 倍），避免“目标乱跳→KCM硬拧”
- 可选再加一层“a_ref 的变化限幅”（类 jerk）：  
  - `a_ref = clip((v_target - v_target_prev)/dt, -a_ref_max, a_ref_max)`  
  - `|a_ref - a_ref_prev| <= j_ref_max * dt`（j_ref_max 取 0.3~0.6*MAX_JERK）

> 注意：这层是“参考规划器”，KCM 仍是最终硬约束。目标器只是在策略与 KCM 之间做缓冲。

### 2.2 输出诊断（必须）
在 info 里输出：
- `v_des, v_target, v_exec`
- `du_v, du_theta`
- `kcm_intervention`

---

## 任务 3：新增 tools/p6_smoothness_report.py（必做）
报告内容（必须输出）：
1) `mean(|Δu|), p90(|Δu|)`（动作抖动）
2) `kcm_intervention_mean/p90`（KCM 干预）
3) `jerk_mean, angular_jerk_mean`
4) `success_rate/oob_rate/steps_mean/v_mean`（line/square/s_shape，E=20）

并提供 A/B 对比：
- A：关闭 r_du 与目标器  
- B：开启 r_du 与目标器  
验收：B 的平顺性指标下降（至少两项显著下降），同时 success 不下降；v_mean/steps_mean 不明显变差（最好更好）。

---

## 自验证/验收标准（你将这样验证）
1) **抖动下降（硬指标）**  
   - 运行 `tools/p6_smoothness_report.py`  
   - **验收：** `mean(|Δu|)` 与 `kcm_intervention_mean` 至少有一项下降，最好两项都下降

2) **稳定性不下降（硬指标）**  
   - quick_eval（line/square/s_shape，E=20）  
   - **验收：** success_rate 不下降，oob_rate 不上升

3) **仍然快（硬指标）**  
   - **验收：** line 的 `v_mean` 不明显下降；square 在不增 oob 的前提下 `steps_mean` 不上升（最好下降）

---

## 交付物（提交时必须包含）
1) 改动文件列表 + r_du 与目标器公式说明（含 tau / a_ref_max / j_ref_max）  
2) `tools/p6_smoothness_report.py` + A/B 输出样例  
3) quick_eval 输出样例（line/square/s_shape）
