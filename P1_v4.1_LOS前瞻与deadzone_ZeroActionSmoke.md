# P1ï¼ˆv4ï¼‰ï¼šLookahead/LOS å‚è€ƒæ–¹å‘ + å…å·®å¸¦ Deadzoneï¼ˆåœ†å¼§åŒ–æ‹è§’ï¼‰ï¼ˆç»Ÿä¸€è„šæœ¬è‡ªéªŒè¯ + è‡ªåŠ¨éªŒæ”¶ + äººå®¡æ¸…å•ï¼‰

> è¿è¡Œæ–¹å¼ï¼šå…ˆæ¿€æ´» PPO è™šæ‹Ÿç¯å¢ƒ (`conda activate PPO`)ï¼Œç„¶ååœ¨ `PPO_project` ç›®å½•æ‰§è¡Œ `python` å‘½ä»¤ã€‚


> å…³é”®é˜²å‡é˜³æ€§ï¼š  
> P1 çš„ smoke å¿…é¡»ç”¨ **Zero Action Policy**ï¼ˆåŠ¨ä½œå…¨ 0 æˆ–è‡³å°‘ Ï‰=0ï¼‰æ¥â€œç…§å¦–é•œå¼â€éªŒè¯ `theta_ref` æœ¬èº«æ˜¯ä¸æ˜¯è¿ç»­ã€æ˜¯ä¸æ˜¯æå‰è½¬å‘ã€‚  
> å› ä¸º P0 æ”¹æˆ Residual åï¼š**åªè¦ Ï‰=0ï¼Œç³»ç»Ÿå°±ä¼šå®Œç¾è¿½è¸ª theta_ref**ï¼ˆå‰©ä¸‹å°±æ˜¯çœ‹ theta_ref ç®—å¾—å¯¹ä¸å¯¹ï¼‰ã€‚  
>
> æœ¬æ–‡æ¡£çš„ smoke è®¾è®¡ï¼š**å¼ºåˆ¶ Ï‰=0ï¼ˆé›¶è½¬å‘æ®‹å·®ï¼‰+ å›ºå®šæ­£å‘é€Ÿåº¦ v_const**ï¼Œè¾“å‡ºè½¨è¿¹åŸºæœ¬å°±æ˜¯ `theta_ref` çš„â€œåŸå§‹å½¢æ€â€ã€‚  
> å¦‚æœè¿™æ¡è½¨è¿¹åœ¨æ‹è§’è¿˜æ˜¯å°–çš„ï¼šä¸ç”¨è®­ç»ƒï¼Œç›´æ¥è¯´æ˜ Lookahead æ²¡ç”Ÿæ•ˆæˆ– L å‚æ•°ä¸å¯¹ã€‚

---

## Step 0ï¼šè¿åŠ¨å­¦å‚æ•°ç»Ÿä¸€é…ç½®ï¼ˆP1/P2/P3 å…±ç”¨ï¼‰

> **é‡è¦**ï¼šä»¥ä¸‹å‚æ•°ä» P1 å¼€å§‹ç”Ÿæ•ˆï¼Œæ‰€æœ‰åç»­é˜¶æ®µï¼ˆP2ã€P3ï¼‰æ²¿ç”¨ç›¸åŒé…ç½®ã€‚

### 0.1 ç»Ÿä¸€è¿åŠ¨å­¦çº¦æŸ

åœ¨ `configs/train_square_p1.yaml`ï¼ˆåŠåç»­ P2/P3 é…ç½®ï¼‰ä¸­è®¾ç½®ï¼š

```yaml
kinematic_constraints:
  MAX_VEL: 100.0       # 100 mm/sï¼ˆå³ 6000 mm/minï¼‰
  MAX_ACC: 2000.0      # 2000 mm/sÂ²
  MAX_JERK: 20000.0    # 20000 mm/sÂ³
  MAX_ANG_VEL: 6.283185307179586   # 2Ï€ rad/s
  MAX_ANG_ACC: 100.0   # rad/sÂ²
  MAX_ANG_JERK: 1000.0 # rad/sÂ³
```

### 0.2 å‚æ•°è¯´æ˜

| å‚æ•° | å€¼ | å•ä½ | ç­‰æ•ˆ (mm/min) |
|------|-----|------|---------------|
| MAX_VEL | 100 | mm/s | 6000 mm/min |
| MAX_ACC | 2000 | mm/sÂ² | 7,200,000 mm/minÂ² |
| MAX_JERK | 20000 | mm/sÂ³ | 4.32Ã—10â¹ mm/minÂ³ |

---

## Step 0.5ï¼šå‰ç½®é—¸é—¨ï¼ˆå¿…é¡»ï¼‰
P0 å¿…é¡»å·² PASSï¼Œå¹¶ä¿å­˜æœ€ä½³åŸºçº¿ï¼š
- `artifacts/p0_accept/summary.json`ï¼ˆ`passed=true`ï¼‰

> âš ï¸ é˜²"ä¼ªé€šè¿‡"ï¼šP1 éªŒæ”¶æ—¶çš„ `--baseline` **å¿…é¡»æŒ‡å‘è¿™æ¬¡æœ€å¥½çš„ PASS ç»“æœ**ã€‚  
> ç»Ÿä¸€åšæ³•ï¼šåªå…è®¸ç”¨ `artifacts/p0_accept/summary.json` ä½œä¸º baselineã€‚è„šæœ¬ä¼šæ‹’ç» `passed!=true` çš„ baselineã€‚

---

## Step 1ï¼šå‚è€ƒæ–¹å‘æ”¹ä¸º Lookahead LOS + åŠ¨æ€ L(v)
æ–‡ä»¶ï¼š`src/environment/cnc_env.py`

### 1.1 å¿…é¡»åšï¼šåŠ¨æ€å‰ç» L(v)
- `L(v) = clip(L0 + kL*v_exec, Lmin, Lmax)`
- é€Ÿåº¦è¶Šå¤§ï¼Œçœ‹å¾—è¶Šè¿œï¼›å¼¯åŠå¾„è‡ªç„¶å¢å¤§ï¼ˆç‰©ç†ä¸€è‡´ï¼‰

### 1.2 å¿…é¡»è§„é¿ï¼šè·¯å¾„æœ«ç«¯è¶Šç•Œ
**å¼ºåˆ¶è¦æ±‚**ï¼šä½¿ç”¨ç¯å¢ƒå·²æœ‰çš„ `_interpolate_progress_point_at_s` / `_compute_los_metrics`  
å®ƒä»¬å·²å¤„ç† closed å–æ¨¡ã€open clampï¼Œé¿å… `s+L` è¶Šç•Œå¯¼è‡´å‚è€ƒè§’è·³å˜ã€‚

---

## Step 2ï¼šå…å·®å¸¦ Deadzoneï¼ˆä»…å…¥å¼¯é˜¶æ®µç”Ÿæ•ˆï¼‰
æ–‡ä»¶ï¼š`src/environment/reward.py`

> [!IMPORTANT]
> **å…³é”®è®¾è®¡**ï¼šDeadzone **ä»…åœ¨å…¥å¼¯é˜¶æ®µï¼ˆcorner_phase="enter"ï¼‰ç”Ÿæ•ˆ**ï¼Œå‡ºå¼¯é˜¶æ®µæ¢å¤æ­£å¸¸è¯¯å·®æƒ©ç½šã€‚
> è¿™é¿å…äº†å‡ºå¼¯æ—¶è¯¯å·®ä¸å—æƒ©ç½šå¯¼è‡´çš„"å›çº¿å»¶è¿Ÿ"é—®é¢˜ã€‚

- å…¥å¼¯é˜¶æ®µï¼š`deadzone = 0.15 * half_epsilon`ï¼ˆå…è®¸åç¦»ä»¥å®ç°åœ†å¼§å†…åˆ‡ï¼‰
- å‡ºå¼¯é˜¶æ®µï¼š`deadzone = 0`ï¼ˆæ¢å¤æ­£å¸¸æƒ©ç½šï¼ŒåŠ é€Ÿå›çº¿ï¼‰
- ç›´çº¿é˜¶æ®µï¼š`deadzone = 0`

å®ç°ï¼š
```python
# corner_phase: "enter" | "exit" | ""
if corner_phase == "enter":
    dz_ratio = p1_cfg.get("deadzone_enter_ratio", 0.15)
else:
    dz_ratio = 0.0  # å‡ºå¼¯å’Œç›´çº¿æ— deadzone
deadzone = dz_ratio * half_epsilon
e_eff = max(0, abs(e) - deadzone)
```


---

## Step 3ï¼šæ‹è§’ç›¸ä½æƒ©ç½š |angular_acc|ï¼ˆæ¯”ç½š jerk æ›´ç›´æ¥ï¼‰
åŒæ ·åœ¨ `reward.py`ï¼š
- ä»… corner phase å¯ç”¨
- è®©â€œé›†ä¸­è½¬å‘â€å˜è´µ â†’ è¿«ä½¿æå‰å…¥å¼¯ä¸è½¬å‘æ‘Šå¼€ â†’ è½¨è¿¹åœ†å¼§åŒ–

---

# âœ… P1 è‡ªéªŒè¯ï¼ˆsmokeï¼‰ï¼šZero Action Policy ç›´æ¥éªŒè¯ theta_refï¼ˆæ— éœ€è®­ç»ƒï¼‰

## A) ç›®æ ‡
- ç”¨â€œé›¶è½¬å‘æ®‹å·®ï¼ˆÏ‰=0ï¼‰+ å›ºå®šæ­£å‘é€Ÿåº¦ï¼ˆv_constï¼‰â€è·‘ä¸€åœˆ  
- è¾“å‡º `trace.csv`ï¼Œä½ ç”»å‡ºæ¥çš„å°±æ˜¯ theta_ref çš„å½¢æ€  
- ç”¨å®ƒå¿«é€Ÿè°ƒ `Lmin/Lmax/kL`

## B) å‘½ä»¤ï¼ˆè„šæœ¬ä¼šç”Ÿæˆ trace.csvï¼‰
```bash
cd PPO_project
python tools/acceptance_suite.py --phase p1_smoke --config configs/train_square_p1.yaml --episodes 1 --out artifacts/p1_smoke
```

äº§ç‰©ï¼š
- `artifacts/p1_smoke/trace.csv`ï¼ˆå« x,y,theta_ref,e,next_angle,dist_to_turn,v,omega ç­‰ï¼‰
- `artifacts/p1_smoke/summary.json`

## C) ç”¨ smoke å¿«é€Ÿè°ƒ Lï¼ˆå·¥ç¨‹é—­ç¯ï¼‰
1) ç”» `trace.csv` çš„ x-yï¼š
   - æ‹è§’ä»å°–ï¼šé€šå¸¸ **L å¤ªå°**ï¼ˆæˆ– LOS æ²¡è¢«ç”¨ä¸Šï¼‰
   - åˆ‡å¾—å¤ªç‹ ã€æ’è¾¹ç•Œï¼šé€šå¸¸ **L å¤ªå¤§** æˆ– `dz_corner` å¤ªå¤§
2) æ¯æ¬¡åªæ”¹ `Lmin/Lmax/kL` ä¸‰ä¸ªå‚æ•°ï¼Œè·‘ä¸€æ¬¡ p1_smokeï¼Œç›´åˆ°ï¼š
   - ä¸éœ€è¦æ™ºèƒ½ä½“â€œåŠ¨è„‘å­â€ï¼Œå…‰é  theta_ref å°±èƒ½ç”»å‡ºä¸€æ¡ä¸é”™çš„åœ†å¼§
3) ç„¶åå†å¼€å§‹è®­ç»ƒï¼ˆå¦åˆ™è®­ç»ƒä¼šæµªè´¹å¤§é‡ç®—åŠ›å»â€œå¼¥è¡¥åå‚è€ƒä¿¡å·â€ï¼‰

---

# âœ… P1 è‡ªåŠ¨åŒ–éªŒæ”¶ï¼ˆè®­ç»ƒåï¼Œå¸¦ P0 baseline å¯¹æ¯”ï¼‰

è®­ç»ƒï¼š
```bash
python main.py --mode train --config configs/train_square_p1.yaml
```

éªŒæ”¶ï¼ˆbaseline å¿…é¡»æ˜¯ P0 æœ€ä½³ PASSï¼‰ï¼š
```bash
python tools/acceptance_suite.py --phase p1_eval   --config configs/train_square_p1.yaml   --model <PATH_TO_best_model.pth>   --episodes 50   --baseline artifacts/p0_accept/summary.json   --out artifacts/p1_accept --deterministic
```

**è‡ªåŠ¨ PASS æ¡ä»¶ï¼ˆè„šæœ¬å†…ï¼‰**
- ç»§æ‰¿ P0ï¼šsuccess / stall / progress / error ä¸é€€åŒ–
- æ‹è§’å³°å€¼è§’åŠ é€Ÿåº¦è¾ƒ P0 ä¸‹é™ â‰¥ 30%
- æ‹è§’å¹³å‡é€Ÿåº¦ â‰¥ P0 çš„ 80%
- `theta_ref_max_step <= 0.35 rad/step`ï¼ˆå‚è€ƒä¿¡å·è¿ç»­æ€§ï¼‰

> è„šæœ¬ä¼šæ‰“å° baseline æŒ‡æ ‡ä¸å½“å‰æŒ‡æ ‡ï¼Œä¸”ä¼šæ‹’ç» baseline çš„ `passed!=true`ï¼ˆé˜²ä¼ªé€šè¿‡ï¼‰ã€‚

---

# ğŸ‘€ P1 å¿…è¦çš„äººä¸ºéªŒæ”¶æ¸…å•ï¼ˆå¿…è¦æ—¶ï¼‰
1) ç”¨ `trace.csv` äººçœ¼ç¡®è®¤ï¼štheta_ref åœ¨æ‹è§’å‰â€œæå‰æ—‹è½¬â€ï¼Œè½¨è¿¹åœ†å¼§åŒ–  
2) å…å·®å¸¦å†…åˆ‡è§’ä½†ä¸è´´è¾¹ç•Œï¼ˆå¦åˆ™ deadzone å¤ªå¤§æˆ– barrier å¤ªå¼±ï¼‰  
3) åŠ¨æ€ L(v) åˆç†ï¼šé«˜é€ŸåŠå¾„æ›´å¤§ã€ä½é€Ÿæ›´è´´çº¿  
4) é—­åˆ/éé—­åˆè·¯å¾„éƒ½è·‘ä¸€æ¬¡ smokeï¼Œç¡®è®¤ç«¯ç‚¹ä¸è·³å˜
5) **æ–°å¢**ï¼šå‡ºå¼¯æ¢å¤ä¸æ¶åŒ–ï¼ˆexit_recovery_steps â‰¤ P0 Ã— 1.2ï¼‰

---

# ğŸš€ P1 è‡ªåŠ¨åŒ–æ‰§è¡Œè„šæœ¬

**æ‰§è¡Œå…¥å£**ï¼ˆä¿å­˜ä¸º `PPO_project/tools/run_p1_pipeline.ps1`ï¼‰ï¼š

```powershell
# P1 å®Œæ•´æµæ°´çº¿ï¼šSmoke â†’ Train â†’ Eval
param([int]$SmokeEpisodes = 1, [int]$EvalEpisodes = 50, [switch]$SkipSmoke, [switch]$SkipTrain)

$ErrorActionPreference = "Stop"
Set-Location $PSScriptRoot\..

if (-not $SkipSmoke) {
    Write-Host "=== P1 Smoke ===" -ForegroundColor Cyan
    python tools/acceptance_suite.py --phase p1_smoke --config configs/train_square_p1.yaml --episodes $SmokeEpisodes --out artifacts/p1_smoke
    $smoke = Get-Content artifacts/p1_smoke/summary.json | ConvertFrom-Json
    if (-not $smoke.passed) { Write-Error "P1 Smoke FAILED"; exit 1 }
}

if (-not $SkipTrain) {
    Write-Host "=== P1 Train ===" -ForegroundColor Cyan
    python main.py --mode train --config configs/train_square_p1.yaml
}

Write-Host "=== P1 Eval ===" -ForegroundColor Cyan
$latestDir = Get-ChildItem saved_models/train -Directory | Sort-Object Name -Descending | Select-Object -First 1
python tools/acceptance_suite.py --phase p1_eval --config configs/train_square_p1.yaml --model "$($latestDir.FullName)/checkpoints/best_model.pth" --episodes $EvalEpisodes --baseline artifacts/p0_accept/summary.json --out artifacts/p1_accept --deterministic
$eval = Get-Content artifacts/p1_accept/summary.json | ConvertFrom-Json
if ($eval.passed) { Write-Host "P1 PASSED" -ForegroundColor Green } else { Write-Error "P1 FAILED" }
```

**è¿è¡Œ**ï¼š`powershell -NoProfile -ExecutionPolicy Bypass -File PPO_project/tools/run_p1_pipeline.ps1`
