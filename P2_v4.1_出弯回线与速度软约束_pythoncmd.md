# P2ï¼ˆv4ï¼‰ï¼šå‡ºå¼¯å›çº¿å¥–åŠ± + é€Ÿåº¦è½¯çº¦æŸï¼ˆç»Ÿä¸€è„šæœ¬è‡ªéªŒè¯ + è‡ªåŠ¨éªŒæ”¶ + äººå®¡æ¸…å•ï¼‰

> P2 çš„é‡ç‚¹æ˜¯é¿å…â€œå›çº¿é è§„åˆ™æ‹‰å›â€å’Œâ€œç¡¬é€Ÿåº¦ç›®æ ‡å¯¼è‡´æŠ–åŠ¨â€ã€‚  
> åšæ³•ï¼šå›çº¿å¥–åŠ±åªåœ¨ exit window ç”Ÿæ•ˆï¼›é€Ÿåº¦ç”¨è½¯å¯è¾¾æ€§çº¦æŸï¼Œè®©ç­–ç•¥è‡ªå·±æƒè¡¡é€Ÿåº¦ä¸è½¬å‘å¯è¾¾æ€§ã€‚

---

## Step 0ï¼šå‰ç½®é—¸é—¨ï¼ˆå¿…é¡»ï¼‰
P1 å¿…é¡»å·² PASSï¼š
- `artifacts/p1_accept/summary.json`ï¼ˆ`passed=true`ï¼‰

> âš ï¸ åŒæ ·é˜²â€œä¼ªé€šè¿‡â€ï¼šP2 éªŒæ”¶ baseline å¿…é¡»æŒ‡å‘ P1 æœ€ä½³ PASS ç»“æœã€‚è„šæœ¬ä¼šæ‹’ç» `passed!=true`ã€‚

---

## Step 1ï¼šå›çº¿å¥–åŠ±ï¼ˆåªåœ¨ exit window ç”Ÿæ•ˆï¼‰
æ–‡ä»¶ï¼š`src/environment/reward.py`

- ç»´æŠ¤ `e_prev=|e|`
- `delta = e_prev - e_now`
- `r_recover = + w_rec * clip(delta, -d_clip, +d_clip)`
- ä»…åœ¨ `exit_active`/exit window ç”Ÿæ•ˆ

---

## Step 2ï¼šé€Ÿåº¦è½¯çº¦æŸï¼šç”¨æ›²ç‡å¯è¾¾æ€§æƒ©ç½šæ›¿ä»£ç¡¬ç›®æ ‡
- é™ä½/ç§»é™¤ `speed_target_reward`
- `kappa_exec = |omega_exec| / max(v_exec, v_eps)`
- `r_kappa = - w_kappa * relu(kappa_exec - kappa_ref)^2`

---

# âœ… P2 è‡ªéªŒè¯ï¼ˆsmokeï¼‰ï¼šç¡®ä¿ exit æŒ‡æ ‡è®¡ç®—ä¸å´© + trace å¯è§†åŒ–
```bash
cd PPO_project
..\python.cmd tools/acceptance_suite.py --phase p2_smoke --config configs/train_square_p2.yaml --episodes 1 --out artifacts/p2_smoke
```

äº§ç‰©ï¼š`artifacts/p2_smoke/trace.csv`

---

# âœ… P2 è‡ªåŠ¨åŒ–éªŒæ”¶ï¼ˆè®­ç»ƒåï¼Œå¸¦ P1 baseline å¯¹æ¯”ï¼‰
è®­ç»ƒï¼š
```bash
..\python.cmd main.py --mode train --config configs/train_square_p2.yaml
```

éªŒæ”¶ï¼š
```bash
..\python.cmd tools/acceptance_suite.py --phase p2_eval   --config configs/train_square_p2.yaml   --model <PATH_TO_best_model.pth>   --episodes 50   --baseline artifacts/p1_accept/summary.json   --out artifacts/p2_accept --deterministic
```

**è‡ªåŠ¨ PASS æ¡ä»¶ï¼ˆè„šæœ¬å†…ï¼‰**
- ç»§æ‰¿ P1ï¼šsuccess / stall / progress / error ä¸é€€åŒ–
- `exit_recovery_steps_mean` ç›¸å¯¹ P1 ä¸‹é™ â‰¥ 30%
- `corner_mean_speed` â‰¥ P1 çš„ 90%
- å‡ºå¼¯æŒ¯è¡ RMS ä¸é«˜äº 1.10Ã—baseline

---

# ğŸ‘€ P2 å¿…è¦çš„äººä¸ºéªŒæ”¶æ¸…å•ï¼ˆå¿…è¦æ—¶ï¼‰
1) å‡ºå¼¯è¯¯å·®æ•´ä½“ä¸‹é™æ›´å¿«ï¼Œä¸”ä¸ä¼šæ¥å›æ‘†  
2) è§’é€Ÿåº¦/è§’åŠ é€Ÿåº¦æŒ‡ä»¤ä¸å‡ºç°é«˜é¢‘é”¯é½¿ï¼ˆè‹¥æœ‰ï¼šå‡å° w_rec æˆ–ç¼©çŸ­ exit windowï¼‰  
3) é€Ÿåº¦-ç²¾åº¦æƒè¡¡åˆç†ï¼šä¸æ˜¯â€œä¸ºäº†å›çº¿è€Œè¿‡åº¦é™é€Ÿâ€  
4) è®ºæ–‡å‹å¥½ï¼šåš ablationï¼ˆæ— å›çº¿å¥–åŠ±/æ— è½¯çº¦æŸ/æ—  deadzoneï¼‰
