# P3ï¼ˆv4ï¼‰ï¼šé€Ÿåº¦æ¿€åŠ±ä¸ç›´çº¿æ®µé«˜æ•ˆè¿›ç»™ï¼ˆç»Ÿä¸€è„šæœ¬è‡ªéªŒè¯ + è‡ªåŠ¨éªŒæ”¶ + äººå®¡æ¸…å•ï¼‰

> **P3 ç›®æ ‡**ï¼šè§£å†³"å…¨ç¨‹é€Ÿåº¦åä½"é—®é¢˜ã€‚P1/P2 è§£å†³äº†æ‹è§’åœ†å¼§åŒ–ä¸å‡ºå¼¯å›çº¿ï¼Œä½†ç›´çº¿æ®µé€Ÿåº¦ä»è¿œæœªè¾¾åˆ° $v_{\max}$ã€‚  
> P3 é€šè¿‡é€Ÿåº¦æ­£æ¿€åŠ±ã€æ—¶é—´æƒ©ç½šè°ƒä¼˜å’Œçº¦æŸå‚æ•°æ ¡å‡†ï¼Œä½¿æ™ºèƒ½ä½“ä¸»åŠ¨è¿½æ±‚é«˜é€Ÿè¿›ç»™ã€‚

---

## Step 0ï¼šå‰ç½®é—¸é—¨ï¼ˆå¿…é¡»ï¼‰

P2 å¿…é¡»å·² PASSï¼š
- `artifacts/p2_accept/summary.json`ï¼ˆ`passed=true`ï¼‰

> âš ï¸ åŒæ ·é˜²"ä¼ªé€šè¿‡"ï¼šP3 éªŒæ”¶ baseline å¿…é¡»æŒ‡å‘ P2 æœ€ä½³ PASS ç»“æœã€‚

---

## Step 1ï¼šè¿åŠ¨å­¦å‚æ•°å•ä½æ ¡å‡†

æ–‡ä»¶ï¼š`configs/train_square_p3.yaml`

> **é‡è¦**ï¼šç”¨æˆ·ç¡®è®¤åŠ é€Ÿåº¦/æ·åº¦å•ä½åº”ä¸º **mm/minÂ²** å’Œ **mm/minÂ³**

### 1.1 å‚æ•°æ¢ç®—è¡¨

| å‚æ•° | å½“å‰å€¼ï¼ˆmm/s ç³»ï¼‰ | æ¢ç®—åï¼ˆmm/min ç³»ï¼‰ | æ¢ç®—å…¬å¼ |
|------|------------------|---------------------|----------|
| MAX_VEL | 1000 mm/s | 5000 mm/min | Ã—60/12 (ç”¨æˆ·æŒ‡å®š 5000) |
| MAX_ACC | 5000 mm/sÂ² | å¾…å®š mm/minÂ² | Ã—3600 |
| MAX_JERK | 50000 mm/sÂ³ | å¾…å®š mm/minÂ³ | Ã—216000 |

### 1.2 å»ºè®®é…ç½®

```yaml
kinematic_constraints:
  MAX_VEL: 83.33  # 5000 mm/min Ã· 60 = 83.33 mm/sï¼ˆå†…éƒ¨è®¡ç®—ç”¨ sï¼‰
  MAX_ACC: <å¾…ç”¨æˆ·ç¡®è®¤>
  MAX_JERK: <å¾…ç”¨æˆ·ç¡®è®¤>
  # æ³¨ï¼šç¯å¢ƒå†…éƒ¨ç»Ÿä¸€ç”¨ mm/s è®¡ç®—ï¼ŒYAML è¾“å…¥ä¹Ÿåº”ä¸º mm/s
```

> **å¾…ç¡®è®¤**ï¼šè¯·æä¾›ç›®æ ‡åŠ é€Ÿåº¦å’Œæ·åº¦çš„ mm/min å•ä½å€¼ï¼Œæˆ‘å°†æ¢ç®—ä¸º mm/s å¡«å…¥ YAMLã€‚

---

## Step 2ï¼šé€Ÿåº¦æ­£æ¿€åŠ±æœºåˆ¶

æ–‡ä»¶ï¼š`src/environment/reward.py`

### 2.1 å¢åŠ é€Ÿåº¦æ¿€åŠ±é¡¹

å½“å‰å¥–åŠ±ç»“æ„ï¼ˆP0ï¼‰ï¼š
- `r_progress`ï¼šè¿›åº¦æ­£æ¿€åŠ±ï¼ˆä¸»å¯¼ï¼‰
- `r_track`ï¼šè½®å»“è¯¯å·®æƒ©ç½š
- `r_dir`ï¼šèˆªå‘è¯¯å·®æƒ©ç½š
- `r_time`ï¼šæ—¶é—´æƒ©ç½š

**æ–°å¢**ï¼š
```python
# P3: é€Ÿåº¦æ­£æ¿€åŠ±
v_ratio = v_exec / max(v_max, 1e-6)
r_speed = + w_v * v_ratio  # æ­£æ¿€åŠ±ï¼Œw_v å»ºè®® 2.0~5.0
```

### 2.2 è°ƒæ•´æƒé‡å¹³è¡¡

| æƒé‡ | P0 å€¼ | P3 å»ºè®®å€¼ | è¯´æ˜ |
|------|-------|-----------|------|
| w_s | 20.0 | 20.0~25.0 | ä¿æŒè¿›åº¦ä¸»å¯¼ |
| w_e | 5.0 | 3.0~5.0 | å¯é€‚å½“é™ä½ |
| w_t | 1.0 | 0.5~1.5 | æ—¶é—´æƒ©ç½šé€‚ä¸­ |
| **w_v** | 0.0 | **3.0~5.0** | **æ–°å¢é€Ÿåº¦æ¿€åŠ±** |

---

## Step 3ï¼šç›´çº¿æ®µè¯†åˆ«ä¸å·®å¼‚åŒ–ç­–ç•¥

æ–‡ä»¶ï¼š`src/environment/cnc_env.py`

### 3.1 ç›´çº¿æ®µåˆ¤å®š

```python
# ç›´çº¿æ®µå®šä¹‰ï¼šå‰æ–¹ä¸€å®šè·ç¦»å†…æ— æ˜¾è‘—æ›²ç‡
is_straight = dist_to_turn > d_straight_threshold and abs(kappa) < kappa_straight_eps
```

å‚æ•°å»ºè®®ï¼š
- `d_straight_threshold`ï¼šè‡³å°‘ 3Ã— lookahead_spacing
- `kappa_straight_eps`ï¼š0.01~0.05 rad/mm

### 3.2 ç›´çº¿æ®µé€Ÿåº¦ç›®æ ‡ä¸Šè°ƒ

```python
if is_straight:
    speed_target = v_max * 0.95  # ç›´çº¿æ®µç›®æ ‡æ¥è¿‘æœ€å¤§
else:
    speed_target = v_target_turn_aware  # æ²¿ç”¨ P4.0 çš„ turn-aware ç›®æ ‡
```

---

## Step 4ï¼šæ—¶é—´æƒ©ç½šä¸è¿›åº¦æ¿€åŠ±è”åŠ¨

### 4.1 æ—¶é—´æƒ©ç½šè°ƒä¼˜

å½“å‰ `p4.time_penalty = -0.01`ï¼Œå¯èƒ½è¿‡å°ã€‚

å»ºè®®ï¼š
- è‹¥å¸Œæœ›æ›´ç§¯æè¿½é€Ÿï¼š`time_penalty = -0.05 ~ -0.1`
- é…åˆé€Ÿåº¦æ¿€åŠ±é¿å…"ä½é€Ÿç­‰è¿›åº¦"çš„å±€éƒ¨æœ€ä¼˜

### 4.2 è¿›åº¦å€å¢å™¨ï¼ˆå¯é€‰ï¼‰

åœ¨ç›´çº¿æ®µå¯ä»¥ç»™äºˆæ›´é«˜çš„ `progress_multiplier`ï¼š
```python
progress_multiplier = 1.2 if is_straight else 1.0
r_progress = w_s * progress_diff * progress_multiplier
```

---

# âœ… P3 è‡ªéªŒè¯ï¼ˆsmokeï¼‰ï¼šé€Ÿåº¦å“åº”æµ‹è¯•

## A) ç›®æ ‡
- éªŒè¯é€Ÿåº¦æ¿€åŠ±ç”Ÿæ•ˆï¼šæ’å®šåŠ¨ä½œä¸‹é€Ÿåº¦åº”æ¥è¿‘ v_max
- éªŒè¯ç›´çº¿æ®µé€Ÿåº¦ç›®æ ‡æ­£ç¡®è¯†åˆ«

## B) å‘½ä»¤
```powershell
cd PPO_project
python tools/acceptance_suite.py --phase p3_smoke --config configs/train_square_p3.yaml --episodes 3 --out artifacts/p3_smoke
```

äº§ç‰©ï¼š`artifacts/p3_smoke/trace.csv`

## C) å…³é”®æ£€æŸ¥é¡¹
1. ç›´çº¿æ®µå¹³å‡é€Ÿåº¦ / v_max â‰¥ 0.8
2. é€Ÿåº¦æ¿€åŠ±é¡¹ `r_speed` ä¸ºæ­£
3. æ—  NaN/Inf

---

# âœ… P3 è‡ªåŠ¨åŒ–éªŒæ”¶ï¼ˆè®­ç»ƒåï¼Œå¸¦ P2 baseline å¯¹æ¯”ï¼‰

è®­ç»ƒï¼š
```powershell
python main.py --mode train --config configs/train_square_p3.yaml
```

éªŒæ”¶ï¼š
```powershell
python tools/acceptance_suite.py --phase p3_eval --config configs/train_square_p3.yaml --model <PATH_TO_best_model.pth> --episodes 50 --baseline artifacts/p2_accept/summary.json --out artifacts/p3_accept --deterministic
```

**è‡ªåŠ¨ PASS æ¡ä»¶ï¼ˆè„šæœ¬å†…ï¼‰**
- ç»§æ‰¿ P2ï¼šsuccess / stall / progress / error ä¸é€€åŒ–
- ç›´çº¿æ®µå¹³å‡é€Ÿåº¦ â‰¥ 0.85 Ã— v_max
- å…¨ç¨‹å¹³å‡é€Ÿåº¦è¾ƒ P2 æå‡ â‰¥ 20%
- å®Œæˆæ—¶é—´è¾ƒ P2 ç¼©çŸ­ â‰¥ 15%

---

# ğŸ‘€ P3 å¿…è¦çš„äººä¸ºéªŒæ”¶æ¸…å•ï¼ˆå¿…è¦æ—¶ï¼‰

1) ç›´çº¿æ®µé€Ÿåº¦æ›²çº¿ç¨³å®šåœ¨é«˜ä½ï¼Œæ— å¤§å¹…æ³¢åŠ¨
2) æ‹è§’å¤„ä»ä¿æŒåœ†å¼§è¿‡æ¸¡ï¼ˆä¸å› é€Ÿåº¦æ¿€åŠ±ç ´å P1 æˆæœï¼‰
3) è½®å»“è¯¯å·®ä»åœ¨å®¹è®¸å¸¦å†…ï¼ˆä¸å› è¿½é€Ÿè¶…å·®ï¼‰
4) Reward åˆ†è§£ï¼š`r_speed` è´¡çŒ®æ˜¾è‘—ä½†ä¸å‹è¿‡ `r_progress`

---

# é™„å½•ï¼šP2 æ‰©å±•å»ºè®®

å¦‚æœä¸å¸Œæœ›æ–°å¢ P3ï¼Œå¯ä»¥åœ¨ P2 ä¸­è¿½åŠ ä»¥ä¸‹å†…å®¹ï¼š

## P2.xï¼šé€Ÿåº¦è½¯çº¦æŸå¢å¼º

åœ¨ `Step 2: é€Ÿåº¦è½¯çº¦æŸ` åŸºç¡€ä¸Šå¢åŠ ï¼š

### 2.x.1 é€Ÿåº¦æ­£æ¿€åŠ±
- `r_speed = + w_v * (v_exec / v_max)`
- æƒé‡ `w_v = 3.0`ï¼ˆå¯åœ¨ YAML ä¸­é…ç½®ï¼‰

### 2.x.2 ç›´çº¿æ®µé€Ÿåº¦ç›®æ ‡ä¸Šè°ƒ
- è¯†åˆ«ç›´çº¿æ®µï¼ˆ`dist_to_turn > threshold`ï¼‰
- ç›´çº¿æ®µ `speed_target = 0.95 * v_max`

### 2.x.3 éªŒæ”¶æ¡ä»¶è¿½åŠ 
- ç›´çº¿æ®µå¹³å‡é€Ÿåº¦ â‰¥ 0.85 Ã— v_max
- å…¨ç¨‹å¹³å‡é€Ÿåº¦è¾ƒ P1 baseline æå‡ â‰¥ 15%
