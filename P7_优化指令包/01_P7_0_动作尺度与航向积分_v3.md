# P7.0 动作尺度与航向积分（v3：加入课程学习与数值检查）
**目标**：消除尖角根因；修复动作量纲；让直线速度上得去；为 LOS 与走廊自由内切提供可学习动力学。

## 1) 动作映射（单位统一）
**位置**：`src/environment/cnc_env.py -> Env.step()`

- PPO 输出：
  - `a_theta ∈ [-1,1]`（角速度比）
  - `a_v ∈ [0,1]`（线速度比）

- 映射到物理量（强制）：
  - `omega_intent = a_theta * MAX_ANG_VEL`
  - `v_intent = a_v * MAX_VEL`

- 若存在 cap（v_ratio_cap）：
  - `a_v_cap = min(a_v, v_ratio_cap)`
  - `v_intent = a_v_cap * MAX_VEL`

- 送入约束必须使用物理量：
  - `apply_kinematic_constraints(..., vel_action=v_intent, ang_vel_action=omega_intent, ...)`

- KCM 干预度/日志统一用物理量：
  - `velocity_diff = |v_exec - v_intent|`
  - `omega_diff = |omega_exec - omega_intent|`
  - `kcm_intv = velocity_diff/MAX_VEL + omega_diff/MAX_ANG_VEL`

## 2) 航向积分（去掉每步绑定参考切向）
**位置**：`src/environment/cnc_env.py -> calculate_new_position()`（或等价位置更新函数）

- 新增：`self.heading`
- reset：`heading = path_tangent_at_start`

每步积分（用执行后的 v/omega）：
- `heading_next = wrap_to_pi(heading + omega_exec*dt)`
- `x_next = x + v_exec*dt*cos(heading_next)`
- `y_next = y + v_exec*dt*sin(heading_next)`

允许计算对齐误差：
- `tau = wrap_to_pi(heading - path_tangent)`  
但禁止用 path_tangent 覆盖 heading。

## 3) 状态角度稳定性（推荐）
- 用 `sin(tau), cos(tau)` 替代裸 tau（可选但很稳）

## 4) 课程学习（强烈建议）
- Stage-1：Line
- Stage-2：Gentle turns（加入 LOS cap）
- Stage-3：Square（加入走廊与回中）
- Stage-4：逐步收紧 half_epsilon / 提高约束 / 提高 MAX_VEL

## 5) 自验证（必须新增脚本 tools/accept_p7_0_*.py）
- Line 常量动作：`a_theta=0, a_v=1` → 速度爬升、success、stall=0、无 NaN/Inf
- 圆弧常量动作：`a_theta=0.3, a_v=0.6` → 连续弧线、Δheading 连续、无 NaN/Inf

并在 env 每步加入：
- `assert isfinite(reward/state/v/omega/heading)`，失败保存 trace/seed。
