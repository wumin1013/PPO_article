# P7.0 动作尺度与航向积分（v2，更详细）
**目标**：  
- 解决“尖角折线”根因（参考切向跳变导致）  
- 修复动作量纲（让速度/角速度意图是物理量）  
- 让直线段速度真实可上去，减少 stall，提升到终点概率  
- 为后续 LOS 边界与走廊自由内切提供“可学习的动力学”

---

## 1. 必改点（文件/函数/变量级）
### 1.1 动作映射（单位统一）
**文件**：`src/environment/cnc_env.py`  
**函数**：`Env.step(self, action)`  
当前逻辑（问题）：  
- `policy_length∈[0,1]` 直接当作 `raw_linear_vel_intent`  
- `policy_theta∈[-1,1]` 直接当作 `raw_angular_vel_intent`  
但 `apply_kinematic_constraints(... vel_action, ang_vel_action, ..., MAX_VEL, MAX_ANG_VEL ...)` 期望的是**绝对物理量**。

**修改要求**（强制）：
- 仍裁剪动作到 [-1,1]/[0,1]，保持 log_prob 一致
- 在送入约束前映射：
  - `omega_intent = policy_theta * self.MAX_ANG_VEL`
  - `v_intent = v_ratio_intent * self.MAX_VEL`
- turning-feasible cap 也在**比值空间**做，但最终喂给约束的是绝对速度：
  - `v_ratio_intent = min(policy_length, v_ratio_cap)`
  - `v_intent = v_ratio_intent * self.MAX_VEL`
  - `max_vel_cap = v_ratio_cap * self.MAX_VEL`（这个保留）

**同时修复**：KCM 干预度计算
- 现在用 `abs(self.velocity - raw_linear_vel_intent)` 会把“绝对速度 vs 比值”乱减，数值毫无意义  
- 应改为：  
  - `velocity_diff = abs(self.velocity - v_intent)`  
  - `angular_vel_diff = abs(self.angular_vel - omega_intent)`  
  - 干预度建议归一化成比值：  
    - `kcm_intv = (velocity_diff/self.MAX_VEL) + (angular_vel_diff/self.MAX_ANG_VEL)`

> 验收时必须打印：`v_intent, v_exec, v_ratio_exec, omega_intent, omega_exec`

---

### 1.2 航向积分（去除每步绑定参考切向）
**文件**：`src/environment/cnc_env.py`  
**函数**：`Env.calculate_new_position(self, theta_prime_action, length_prime_action)`

当前逻辑（问题）：
```python
path_angle = self._get_path_direction(self.current_position)
effective_angle = path_angle + theta_prime_action * dt
x_next = x + (length_prime_action*dt)*cos(effective_angle)
```
这里 `path_angle` 在角点处跳变（90°），会把轨迹“折”成尖角；同时策略的航向不是状态量，偏离后难以回中。

**修改要求**（强制）：
- 新增状态：`self.heading`（或复用 `self._current_direction_angle` 但语义改为“真实航向”）
- reset 初始化：`heading = initial_direction_angle`
- 每步积分：
  - `heading_next = wrap(heading + omega_exec * dt)`
  - `x_next = x + v_exec*dt*cos(heading_next)`
  - `y_next = y + v_exec*dt*sin(heading_next)`
- `calculate_direction_deviation()` 等“对齐误差”仍可用 `wrap(heading - path_tangent)`，但**绝对不能**再用 path_tangent 重置 heading。

**wrap 要求**：统一使用 `wrap_to_pi`（[-pi, pi]），并避免分支错误。

---

### 1.3 观测/状态的一致性（避免训练“看不见自己航向”）
目前 state 包含 `tau`（方向偏差）但不包含 heading。P7.0 最小改动可以只保留 tau，但建议（更稳）新增：
- `sin(tau), cos(tau)` 代替裸 tau（避免角度跳变）
或新增：
- `heading_sin, heading_cos`（可选）

**要求**：如果你改变 state 维度，必须同步：
- `self.base_state_keys`（若存在）
- `normalize_state()` 的 key 与归一化上限
- `tests/parity_check.py` 或相关 obs check 通过

---

## 2. 自验证（必须新增自动化验收脚本）
新增：`tools/accept_p7_0_dynamics_and_scale.py`

### 2.1 Test-1：直线常量动作
- 场景：Line
- 动作：`a_theta=0, a_v=1`
- 期望：
  - `v_exec` 在若干步内爬升到 ≥ 0.85*MAX_VEL（受 acc/jerk 限制）
  - `|tau|` 维持接近 0
  - `success=True`（open path）
  - `stall_triggered=False`

### 2.2 Test-2：圆弧常量动作
- 场景：空旷（Line 也可）
- 动作：`a_theta=0.3, a_v=0.6`
- 期望：
  - `heading` 连续变化（相邻步 Δheading 不出现突跳）
  - 轨迹形成连续弧线
  - `|omega_exec| ≤ MAX_ANG_VEL`（严格）

### 2.3 输出要求
脚本必须输出一行 summary（便于 grep）：
- `SUCCESS=1/0, v_mean=..., v_p90=..., kcm_intv_mean=..., heading_jump_max=...`
并保存：
- `out/accept_p7_0_trace.csv`
- `out/accept_p7_0_path.png`

---

## 3. 通过门槛（不通过就不要做 P7.2）
- Test-1 success  
- `v_mean_last20% ≥ 0.85*MAX_VEL`  
- `heading_jump_max ≤ 1.2*MAX_ANG_VEL*dt`（允许少量数值误差）  
- kcm_intv_mean 在直线段应很小（表示约束没在乱裁剪）

