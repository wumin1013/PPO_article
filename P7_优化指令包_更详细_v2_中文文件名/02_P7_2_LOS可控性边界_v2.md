# P7.2 LOS 可控性边界（v2，更详细）
**目标**：把“走得更聪明（提前转向/平滑内切）→ 允许更快”的因果链写成硬机制。  
这一步完成后，策略才会有动力学意义上的“内切折中”，而不是机械贴线。

---

## 0. 前置条件
- P7.0 已完成：存在真实 `heading`，且动作映射到物理量。
- 你当前 P4 cap（基于参考切向 delta_theta）必须被 LOS cap 替换或并行对比。

---

## 1. 变更点（文件/函数级）
### 1.1 在 P4 预计算状态中替换 kappa
**文件**：`src/environment/cnc_env.py`  
**函数**：`_compute_p4_pre_step_status()`（或你实际用于计算 v_ratio_cap 的函数）

当前：`kappa_ref ≈ |delta_theta_ref| / s_lookahead`  
问题：与实际内切几何弱耦合 → 内切不带来更高 cap。

**改为（LOS）**：
1) 取 lookahead 点 `p_LA`（建议用你已有 `_get_lookahead_targets()` 的第 1 个点）  
2) `alpha = atan2(p_LA.y - pos.y, p_LA.x - pos.x)`  
3) `delta = wrap(alpha - heading)`  
4) `kappa_LOS = |delta| / (d_LA + eps)`  
   - `d_LA` 建议用 `||p_LA - pos||`（更直接、更稳）  
5) `v_cap = MAX_ANG_VEL / (kappa_LOS + eps)`  
6) `v_ratio_cap = clip(v_cap / MAX_VEL, 0, 1)`

> 关键：delta 必须用**当前 heading**，不能再用参考切向。

### 1.2 多预瞄 minimax（强烈推荐）
使用多个 lookahead 点（例如你已有 lookahead_points）：
- 对每个点 i 计算 `delta_i, d_i, kappa_i`
- `kappa = max_i kappa_i`（取最严格者）
- 输出 debug：`kappa_i_list`（至少保存到 info/p4_status）

理由：工业前瞻本质就是“看远处最急的那段”，提前减速。

### 1.3 角加速度/角 jerk 的扩展（可选，P7.2b）
如果你要“弯前降速像真正可控边界”，建议在 cap 里叠加角加速度/角 jerk 可达性（不是奖励项）：
- 估算未来需要的 `omega_req ≈ v * kappa`
- 由 `MAX_ANG_ACC, MAX_ANG_JERK` 推一个可达 omega 上限（短视界）  
这部分可作为后续 P8，但你也可在 P7.2 提供 hook。

---

## 2. 自验证（必须新增自动化验收脚本）
新增：`tools/accept_p7_2_los_cap_coupling.py`

### 2.1 Test-1：直线 cap 放开
- 场景：Line
- 期望：`v_ratio_cap` 在大部分步接近 1（例如 p50 ≥ 0.95）

### 2.2 Test-2：拐角 cap 提前下压（相对角点提前）
- 场景：Square
- 记录：`v_ratio_cap` 随 progress 的曲线
- 期望：
  - cap 在距离角点还有明显余量时就开始下降（“弯前降速”）
  - cap 下降与 `delta_i`/`kappa_i` 上升同步

### 2.3 Test-3：内切几何对 cap 有正向贡献
用两个启发式控制器（无需训练）制造两种走位：
- Controller-A：更早转向（heading 更早对准 LOS）
- Controller-B：更晚转向（临近角点才大转向）

期望：
- A 的 `kappa_LOS` 明显更小、`v_ratio_cap` 明显更高  
- 输出差值：`Δv_ratio_cap_mean ≥ 0.1`（阈值可按实际调，但必须“可观”）

---

## 3. 通过门槛
- Test-1/2/3 全通过  
- 且 debug 日志能解释：cap 的变化来源于 LOS 几何（不是随机噪声）

