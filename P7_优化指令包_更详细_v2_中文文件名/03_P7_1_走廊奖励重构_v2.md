# P7.1 走廊奖励重构（v2，更详细）
**目标**：把“走廊内跟踪固定 e_target”改成“走廊可行集合内优化速度–误差折中”。  
你想要的是：内切幅度随曲率/边界/速度收益自选，并且出弯能回到参考附近。

---

## 0. 关键原则（不要再踩坑）
- 走廊内**不要**追固定目标线（`|e_n - e_target|` 会压扁探索空间）
- 走廊内只定义：
  1) **硬可行域**（越界强罚 / done）
  2) **边界风险势垒**（靠边更危险）
  3) **方向性偏好**（内切方向正确，但幅度自由）
- 出弯阶段要有“回中”机制，否则策略会沿着偏移线继续跑（你现在的现象 3）

---

## 1. 变更点（文件/函数级）
### 1.1 改 corridor reward 形状
**文件**：`src/environment/cnc_env.py`  
**函数**：`calculate_reward()`

找到：
- `corridor_target_error = |e_n - e_target|`
并将其替换为下述结构：

#### A) 越界惩罚（outside penalty）
- 若 `e_n < lower` 或 `e_n > upper`：
  - `outside_dist = dist_to_interval`（你 corridor_status 已提供）
  - `r_out = - w_out * outside_dist^2`
  - 严格模式：直接 done（由 is_done 处理），reward 仍给大负值

#### B) 走廊内势垒（barrier on margin）
- `margin = min(e_n - lower, upper - e_n)`（距离最近边界）
- 势垒函数推荐二选一（避免过硬）：
  1) `r_bar = - w_bar * exp(-margin / s)`  
  2) `r_bar = - w_bar / (margin + eps)`
- 目标：让贴边越来越“贵”，但在走廊中央附近几乎不罚。

#### C) 方向性偏好（弱引导，不固定幅度）
- `turn_sign ∈ {-1, +1}`
- `r_pref = + w_in * tanh(turn_sign * e_n / corridor_half)`  
解释：
- turn_sign * e_n > 0 表示朝内侧  
- tanh 饱和，避免把策略推到边界死贴

### 1.2 出弯回中（re-centering schedule）
**文件**：`src/environment/cnc_env.py`  
**函数**：`calculate_reward()` 或 P4 exit boost 逻辑附近

实现一个“权重调度”：
- corner_phase：`w_center = 0` 或很小
- exit_window（corner_phase 刚结束后的 N 步）：`w_center` 从小线性升到大
- straight：`w_center` 保持较大（防止长时间偏移）

回中项：
- `r_center = - w_center * |e_n|`（或 -e_n^2）

> 注意：回中项不要在 corner_phase 内太强，否则会把内切又拉回中心，学不出幅度。

### 1.3 观测中加入“走廊上下文”（强烈推荐）
当前 policy 可能只能靠 dist_to_turn/next_angle 推断是否在 corner_phase，信号弱且不稳定。

建议在 state 追加（不需要很多维）：
- `in_corner_phase`（0/1）
- `turn_sign`（-1/0/+1）
- `e_n_norm = clip(e_n / corridor_half, -1, 1)`
- `margin_norm = clip(margin / corridor_half, 0, 1)`

这些来自 `corridor_status`，计算成本极小，但能显著降低“机械行为”。

要求同步：
- reset/step 构建 state 的位置
- `normalize_state()` 与 `normalization_params`
- 相关 obs tests 通过

---

## 2. 自验证（必须新增自动化验收脚本）
新增：`tools/accept_p7_1_corridor_free_amp_and_recenter.py`

### 2.1 Test-1：e_n 分布不被钉死
- 路径：Square
- 运行：用启发式控制器 + 少量随机噪声（或不同 seed）跑 10 episodes
- 统计：corner_phase 内 e_n 的分布
- 期望：
  - `std(e_n_corner) ≥ 0.1*corridor_half`（不再接近 0）
  - 且 e_n 的符号应与 turn_sign 一致（内侧方向正确）

### 2.2 Test-2：出弯回中
- 统计：离开 corner_phase 后 N 步（例如 N=100）
- 期望：
  - `median(|e_n|)` 单调下降趋势明显
  - 在 N 步内降到 `≤ 0.2*corridor_half`

### 2.3 可视化输出（必须）
- 保存每个 episode 的：
  - path.png（轨迹 + 允差带）
  - e_n_vs_step.png
  - v_ratio_exec_vs_step.png
并输出 summary。

---

## 3. 通过门槛
- Test-1/2 通过  
- 且不会显著拉低直线速度（Line 场景仍需满足 P7 总体验收）

