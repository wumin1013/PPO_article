# P7.3 平滑与终点可靠性（v2，更详细）
**目标**：在 P7.0–P7.2–P7.1 基础上收口，使策略更像“顶级数控”：  
- 拐角圆滑（连续航向 + 近似连续曲率）  
- 弯前降速由边界驱动，不被 stall 误杀  
- open-path 终点 success 触发稳定

---

## 1. 平滑：从“动作差”转向“曲率连续”
### 1.1 曲率定义（必须用执行量）
- `kappa = |omega_exec| / (v_exec + eps)`  
使用执行后的 `omega_exec` 与 `v_exec`（即约束后的动作），不要用 policy 输出。

### 1.2 平滑项（建议同时用）
- `r_kappa = - w_kappa * kappa^2`（抑制过大曲率）
- `r_dkappa = - w_dkappa * (kappa - kappa_prev)^2`（鼓励连续曲率）

推荐初始权重（仅作为起点，后续可扫参）：
- `w_kappa ~ 0.1 ~ 1.0`
- `w_dkappa ~ 0.5 ~ 5.0`（通常比 w_kappa 更关键）

> 目标不是“把弯抹平到不转”，而是消灭尖角式曲率突变，让弯更圆。

---

## 2. stall 逻辑：与 corner_phase/cap 联动
### 2.1 禁止在 corner_phase 内触发 stall
**文件**：`src/environment/cnc_env.py`  
**函数**：`step()` 的 P4 stall 逻辑

要求：
- 当 `corridor_status.corner_phase=True` 时：
  - stall_counter 不累计（或阈值放宽 5~10 倍）

原因：弯前降速本来就是 cap 的结果，不能被当成“停滞”。

### 2.2 与 cap 联动的 stall 判据
当 cap 很低时，即使 v_ratio_exec 小也合理：
- 若 `v_ratio_cap < cap_low`（例如 0.2）：
  - 只用 progress_diff 判断 stall  
- 否则才使用 “progress_diff + 低速” 的联合条件

---

## 3. success 判据：避免“错过终点触发”
**文件**：`src/environment/cnc_env.py`  
**函数**：`is_done()` 或 success 检测处

保留“跨终点线”触发，但增加备用：
- `progress > 0.995 && end_distance < half_epsilon` → success

终点奖励（terminal bonus）建议足够大（例如 +200 或更高），以压过 time penalty 并避免策略中途摆烂。

---

## 4. 自验证（必须新增自动化验收脚本）
新增：`tools/accept_p7_3_smooth_and_finish.py`

### 4.1 Smoothness 指标（必须输出）
- `kappa_max`
- `dkappa_max`（相邻步差分最大值）
- `dkappa_p95`
并在 Square 场景：
- 要求 `dkappa_max` 相比 P6 明显下降（至少下降一个量级或达到明确阈值）

### 4.2 Finish 指标（必须输出）
- success_rate（10 episodes）
- stall_triggered_rate
- mean_steps_to_success（成功回合步数均值）

---

## 5. 通过门槛（建议）
- Square：success_rate ≥ 0.8（训练后 ≥0.9）  
- stall_triggered_rate ≤ 0.05  
- dkappa_p95 显著下降（达到你设定阈值，或相对基线下降 ≥50%）

