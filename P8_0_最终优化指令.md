# ðŸŽ¯ P8.0 æœ€ç»ˆä¼˜åŒ–æŒ‡ä»¤ï¼ˆå¯ç›´æŽ¥å‘ç»™ Codex / Cursor / AI ç¼–ç¨‹åŠ©æ‰‹ï¼‰
> ç›®æ ‡ï¼š**æŽ¨ç¿»**â€œä¿å§†å¼ä¼ªè§„åˆ™â€ï¼Œå›žå½’ **çœŸå®žå‡ ä½• + çœŸå®žåŠ¨åŠ›å­¦**ã€‚  
> ä¿®å¤ï¼š**ç›´çº¿ç”»å¼§ã€S åž‹åœæ»žã€æ–¹å½¢ç¬¬ä¸€æ‹è¿‡ä¸åŽ»**ï¼Œå¹¶å®žçŽ° **ç›´çº¿æœ€å¿«åˆ°ç»ˆç‚¹ä¸”åœä¸‹**ã€‚

---

## 0) Root Cause Verdictï¼ˆæ ¹å› å®šæ€§ï¼‰
å½“å‰å¤±è´¥ä¸æ˜¯ PPOâ€œå­¦ä¸ä¼šâ€ï¼Œè€Œæ˜¯çŽ¯å¢ƒæŠŠä¸‰ä»¶äº‹åšé”™äº†ï¼š

1) **æŠŠ LOSï¼ˆè¿½ç‚¹å¤¹è§’/æ¨ªå‘è¯¯å·®ï¼‰å½“æˆæ›²çŽ‡**ï¼š  
   ç›´çº¿åªè¦åä¸€ç‚¹å°±è¢«è¯¯åˆ¤æˆâ€œæ€¥å¼¯â€ï¼Œå¯¼è‡´ **è¶Šåè¶Šæ…¢ï¼Œè¶Šæ…¢è¶Šå**ã€‚

2) **ç¼ºå¤±åˆ¹è½¦åŒ…ç»œ**ï¼ˆphysics braking envelopeï¼‰ï¼š  
   æ™ºèƒ½ä½“ä¸çŸ¥é“â€œå¦‚æžœçŽ°åœ¨ä¸å‡é€Ÿï¼Œç‰©ç†ä¸Šæ ¹æœ¬åˆ¹ä¸ä½â€ï¼ŒäºŽæ˜¯è¢«è¿«æå‰åˆ‡å†…æˆ–æ’žæ­»ã€‚

3) **æ„ŸçŸ¥å¤±çœŸ**ï¼šå¯†é›†é‡‡æ ·ä¸‹ï¼ŒåŸºäºŽç´¢å¼•/ç‚¹è·çš„ `dist_to_turn` å¤±æ•ˆï¼Œè®©æ™ºèƒ½ä½“â€œè¿‘è§†â€â€”â€”çœ‹ä¸åˆ°å®è§‚çš„æ‹è§’ç»“æž„ã€‚

---

## 1) Nonâ€‘Negotiablesï¼ˆç¡¬çº¦æŸï¼Œå¿…é¡»æ»¡è¶³ï¼‰
A) **v_capï¼ˆç‰©ç†é€Ÿåº¦ä¸Šé™ï¼‰åªèƒ½ç”±è·¯å¾„å‡ ä½• + æœºåºŠåŠ¨åŠ›å­¦å†³å®š**ï¼Œä¸¥ç¦ä»»ä½•æ¨ªå‘è¯¯å·®/LOS è§’åº¦å‚ä¸Ž v_capã€‚  
B) **å¿…é¡»å¼•å…¥åˆ¹è½¦åŒ…ç»œ**ï¼šå½“å‰ä½ç½®é€Ÿåº¦å¿…é¡»å¯åœ¨ `dist_to_turn`ï¼ˆæˆ– `dist_to_end`ï¼‰å†…é™åˆ°å…è®¸é€Ÿåº¦ï¼Œå¦åˆ™å¿…é¡»ç¡¬æˆªæ–­ã€‚  
C) `dist_to_turn` å¿…é¡»æ˜¯ **æ²¿è·¯å¾„å¼§é•¿ï¼ˆs åŸŸï¼‰** çš„çœŸå®žè·ç¦»ï¼Œç¦æ­¢â€œåˆ°ä¸‹ä¸€ä¸ªé‡‡æ ·ç‚¹æ¬§æ°è·/ç´¢å¼•å·®â€ã€‚  
D) **ä¸æ”¹å˜ observation çš„ shape**ï¼šåªæ›¿æ¢çŽ°æœ‰ state ä¸­å¯¹åº”å­—æ®µçš„**è¯­ä¹‰ä¸Žè®¡ç®—**ï¼Œé¿å…è®­ç»ƒæŽ¥å£å´©æŽ‰ã€‚  
E) **æ•°å€¼ç¨³å®šæ€§æ˜¯ä¿å‘½çº§è¦æ±‚**ï¼šæ‰€æœ‰åˆ†æ¯å¿…é¡»åŠ  `EPS=1e-6`ï¼Œå¹¶é˜²æ­¢ NaN/Inf ä¼ æ’­ã€‚  
F) **ç»ˆç‚¹åœä¸‹æ˜¯ç¡¬çº¦æŸ**ï¼šOpen Path ä»»åŠ¡å¿…é¡»åŠ å…¥ `v_brake_end`ï¼Œé¿å…ç›´çº¿å†²è¿‡å¤´ã€‚

---

## 2) ä»»åŠ¡ä¸€ï¼šæ„ŸçŸ¥é‡æž„ï¼ˆä»Žâ€œæ•°ç‚¹/ç´¢å¼•â€æ”¹ä¸ºâ€œå¼§é•¿æ‰«æ s åŸŸâ€ï¼‰
**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/environment/cnc_env.py`

### 2.1 æ–°å¢žå‡½æ•°ï¼š`_scan_for_next_turn(s_now: float) -> dict`
è¿”å›žè‡³å°‘åŒ…å«ï¼š
- `dist_to_turn: float`ï¼šæ²¿å¼§é•¿åˆ°ä¸‹ä¸€å¤„æ˜¾è‘—è½¬å‘äº‹ä»¶çš„è·ç¦»ï¼›è‹¥æ— äº‹ä»¶è¿”å›ž `inf`
- `turn_angle: float`ï¼šè¯¥äº‹ä»¶çš„å‡€è½¬è§’ï¼ˆå¸¦ç¬¦å·ï¼Œwrap åˆ° [-pi, pi]ï¼‰
- `turn_sign: int`ï¼šsign(turn_angle)ï¼›æ— äº‹ä»¶ä¸º 0
- `turn_s: float`ï¼šäº‹ä»¶å¯¹åº”å¼§é•¿ä½ç½®ï¼ˆdebug/éªŒæ”¶ï¼‰
- `is_isolated_corner: bool`ï¼šå­¤ç«‹æ‹è§’ï¼ˆæ–¹å½¢ï¼‰ vs å¤åˆå¼¯ï¼ˆS åž‹ï¼‰

### 2.2 å®žçŽ°è¦æ±‚ï¼ˆç¬¬ä¸€æ€§ + å¯æ³›åŒ–ï¼‰
- æ‰«æå¿…é¡»åœ¨ **s åŸŸ**ï¼šä»Ž `s_now` å¼€å§‹å‘å‰å– `s_now + i*ds`  
  `ds` å– `lookahead_spacing`ï¼ˆæˆ–å…¶å€æ•°ï¼‰ï¼Œå¿…é¡» > 0ã€‚
- ç”¨åˆ‡å‘è§’å˜åŒ–çŽ‡ä½œæ›²çŽ‡ä»£ç†ï¼ˆæ•°å€¼ç¨³å®šï¼‰ï¼š
  - `theta0 = tangent_angle_at_s(s)`
  - `theta1 = tangent_angle_at_s(s + Î”s)`
  - `delta = wrap(theta1 - theta0)`
  - `kappa_proxy = abs(delta) / (Î”s + EPS)`
- é˜ˆå€¼ä¸å¾—æ‹è„‘è¢‹å†™æ­»ï¼šå¿…é¡»ä¸Žå…å·®åŠå®½ `half_eps` å…³è”ï¼š  
  `kappa_th = max(cfg.kappa_th, 0.25 / (half_eps + EPS))`
- æ‰¾åˆ°ç¬¬ä¸€ä¸ª `kappa_proxy > kappa_th` çš„åŒºé—´åŽï¼Œåœ¨å±€éƒ¨çª—å£å†…å–æœ€å¤§ç‚¹ä½œä¸º `turn_s`ã€‚
- `turn_angle` ç”¨çª—å£å‰åŽåˆ‡å‘è§’å·®ä¼°è®¡ï¼ˆæŠ—å™ªï¼‰ï¼š
  - `turn_angle = wrap(theta(turn_s + w) - theta(turn_s - w))`
  - `w = m*ds`ï¼Œm æŽ¨è 2~4ï¼ˆé…ç½®åŒ–ï¼‰

### 2.3 ç”¨ `_scan_for_next_turn` æ›¿æ¢æ—§é€»è¾‘ï¼ˆå¿…é¡»æ”¹åˆ°ä½ï¼‰
- **åºŸå¼ƒ**ï¼šä»»ä½•åŸºäºŽ `next_angle` åˆ—è¡¨æŸ¥ç´¢å¼•ã€`distance_to_next_point` çš„ turn è·ç¦»ä¼°è®¡
- åœ¨ `reset()` ä¸Ž `step()/apply_action()` æ›´æ–° state æ—¶ï¼š
  - `state[3] = dist_to_turn`
  - `state[5] = turn_angle`
- æ³¨æ„ï¼šè‹¥è·¯å¾„æ— æ‹ï¼ˆç›´çº¿ï¼‰ï¼Œ`dist_to_turn = inf`ï¼Œ`turn_angle = 0`ã€‚

---

## 3) ä»»åŠ¡äºŒï¼šè§£ç»‘é™é€Ÿï¼ˆåˆ é™¤ LOSâ†’kappa_selâ†’v_capï¼‰
**ä¿®æ”¹ç‚¹**ï¼š`_compute_p4_pre_step_status()`

### 3.1 å¿…é¡»åˆ é™¤
- ä»»ä½•ä½¿ç”¨ `alpha`ï¼ˆLOS å¤¹è§’ï¼‰æˆ–æ¨ªå‘è¯¯å·® `e_n` è®¡ç®— `kappa_sel` å¹¶å½±å“ `v_cap` çš„é€»è¾‘
- ä»»ä½•æŠŠ `error/alpha` å†™è¿› `v_ratio_cap` çš„é€»è¾‘

### 3.2 å¿…é¡»æ–°å¢žï¼ˆæ›¿ä»£ v_cap è®¡ç®—ï¼šåªçœ‹è·¯å¾„å‡ ä½•ï¼‰
æŽ¨èå®žçŽ°ï¼ˆç¨³ã€å¯è§£é‡Šï¼‰ï¼š
- å–é¢„çž„å¼§é•¿é›†åˆï¼š`s_i = i * lookahead_spacing`, `i=1..N`
- å¯¹æ¯ä¸ª `s_i`ï¼š
  - `theta0 = tangent(s_now)`
  - `theta1 = tangent(s_now + s_i)`
  - `delta = wrap(theta1 - theta0)`
  - `kappa_i = abs(delta) / (s_i + EPS)`
- å…å·®å¸¦å†…â€œå¯åœ†è§’åŒ–â€çš„ä¸Šé™æ›²çŽ‡ï¼ˆé¿å…æ–¹å½¢è§’ç‚¹æ— é™æ›²çŽ‡æŠŠ cap æ‰“åˆ° 0ï¼‰ï¼š
  - `kappa_tol = 1.0 / (half_eps + EPS)`
  - `kappa_eff = min(kappa_i, kappa_tol)`
- ç”¨åŠ¨åŠ›å­¦çº¦æŸè®¡ç®— capï¼ˆä¿ç•™ä½ å·²æœ‰çº¦æŸç»“æž„ï¼Œä½†è¾“å…¥æ¢æˆ `kappa_eff`ï¼‰ï¼š
  - `v_cap_w     = MAX_ANG_VEL  / (kappa_eff + EPS)`
  - `v_cap_wdot  = sqrt(MAX_ANG_ACC  * s_i / (kappa_eff + EPS) + EPS)`ï¼ˆè‹¥å¯ç”¨ï¼‰
  - `v_cap_wddot = cbrt(0.5*MAX_ANG_JERK*s_i*s_i/(kappa_eff + EPS) + EPS)`ï¼ˆè‹¥å¯ç”¨ï¼‰
  - `v_cap_i = min(MAX_VEL, v_cap_w, v_cap_wdot, v_cap_wddot)`
- æœ€ç»ˆï¼š`v_cap = min_i(v_cap_i)`ï¼Œ`v_ratio_cap = clamp(v_cap / MAX_VEL, 0, 1)`

**é‡è¦**ï¼šå¯ä»¥ç»§ç»­è®¡ç®— LOS æŒ‡æ ‡ç”¨äºŽ reward / corridor / debugï¼Œä½† **ä¸å¾—å½±å“ v_cap**ã€‚

---

## 4) ä»»åŠ¡ä¸‰ï¼šå¼•å…¥åˆ¹è½¦åŒ…ç»œï¼ˆPhysics Braking Envelopeï¼‰+ ç»ˆç‚¹åˆ¹è½¦ç¡¬çº¦æŸ
### 4.1 æ‹è§’åˆ¹è½¦ï¼ˆturn brakingï¼‰
åœ¨ `speed_target`ï¼ˆæˆ–ä½ çš„ç›®æ ‡é€Ÿåº¦ shapingï¼‰é‡Œå¿…é¡»åŠ å…¥ï¼š

1) ä»Ž `_scan_for_next_turn` å¾—åˆ° `dist_to_turn`
2) è®¡ç®—æ‹è§’å¤„å…è®¸é€šè¿‡é€Ÿåº¦ï¼ˆä¿å®ˆå³å¯ï¼‰ï¼š
   - `v_limit_at_turn = min(MAX_VEL, MAX_ANG_VEL / (kappa_tol + EPS))`
3) åˆ¹è½¦å€’æŽ¨ä¸Šé™ï¼ˆç»å…¸è¿åŠ¨å­¦ï¼‰ï¼š
   - `v_brake_turn = sqrt(v_limit_at_turn**2 + 2*MAX_ACC*max(dist_to_turn, 0.0) + EPS)`
4) æ›´æ–°ç›®æ ‡é€Ÿåº¦ï¼š
   - `v_target = min(v_target, v_brake_turn)`

çº¦æŸï¼š
- `dist_to_turn = inf` æ—¶ä¸å¯ç”¨ turn brakingï¼ˆç›´çº¿æ— æ‹ä¸è¯¥é™é€Ÿï¼‰
- `MAX_ACC` ç”¨â€œå¯å‡é€Ÿæœ€å¤§åŠ é€Ÿåº¦å¹…å€¼â€ï¼ˆå–ç»å¯¹å€¼ï¼‰

### 4.2 ç»ˆç‚¹åˆ¹è½¦ï¼ˆend brakingï¼Œä¿å‘½çº§ï¼‰
å¯¹äºŽ **Open Pathï¼ˆéžé—­çŽ¯ï¼‰** ä»»åŠ¡ï¼Œå¿…é¡»é¢å¤–è®¡ç®—ç»ˆç‚¹åˆ¹è½¦ä¸Šé™ï¼š
- `dist_to_end = max(total_len - s_now, 0.0)`ï¼ˆæˆ–ä½ çŽ°æœ‰ç»ˆç‚¹è·ç¦»å®šä¹‰ï¼‰
- `v_brake_end = sqrt(2*MAX_ACC*dist_to_end + EPS)`
- `v_target = min(v_target, v_brake_end)`

ç›®çš„ï¼šä¿è¯â€œç›´çº¿æœ€å¿«åˆ°ç»ˆç‚¹å¹¶åœä¸‹â€åœ¨ç‰©ç†ä¸Šå¯è¡Œï¼Œé˜²æ­¢å…¨é€Ÿå†²è¿‡ç»ˆç‚¹ã€‚

---

## 5) ä»»åŠ¡å››ï¼šS åž‹ vs æ–¹å½¢ï¼ˆå†…åˆ‡åç½®åªå¯¹å­¤ç«‹æ‹è§’å¯ç”¨ï¼‰
è¦æ±‚ï¼š`_scan_for_next_turn` è¾“å‡º `is_isolated_corner`ã€‚

åˆ¤åˆ«æ–¹æ³•ï¼ˆåœ¨ turn_s é™„è¿‘çª—å£ç»Ÿè®¡æ›²çŽ‡ç¬¦å·ï¼‰ï¼š
- å¦‚æžœçª—å£å†…åŒæ—¶å­˜åœ¨æ˜¾è‘—æ­£æ›²çŽ‡ä¸Žæ˜¾è‘—è´Ÿæ›²çŽ‡ï¼ˆè¶…è¿‡é˜ˆå€¼ï¼‰ï¼Œåˆ¤å®šä¸º **å¤åˆå¼¯ï¼ˆS åž‹ï¼‰**ï¼š`is_isolated_corner=False`
- å¦åˆ™ä¸º **å­¤ç«‹æ‹è§’ï¼ˆæ–¹å½¢/æŠ˜çº¿ï¼‰**ï¼š`True`

ç­–ç•¥ï¼š
- `is_isolated_corner=False`ï¼šå¼ºåˆ¶å…³é—­å†…åˆ‡åç½®ï¼ˆ`e_target=0`ï¼‰ï¼Œåªä¿ç•™â€œèµ°å»Š/ä¸­çº¿â€å¥–åŠ±
- `is_isolated_corner=True`ï¼šå…è®¸å†…åˆ‡åç½®ï¼ˆæŒ‰ `turn_sign` å°† `e_target` å¹³æ»‘ ramp åˆ° Â±half_epsï¼‰
- å†…åˆ‡åç½®åªèƒ½å½±å“â€œç›®æ ‡æ¨ªå‘ä½ç½®/å¥–åŠ±â€ï¼Œä¸å¾—å‚ä¸Ž v_cap

---

## 6) âœ… éªŒæ”¶è„šæœ¬ï¼šå…ˆè¿‡è‡ªéªŒè¯ï¼Œå†è®­ç»ƒï¼ˆå¿…é¡»ï¼‰
æ–°å¢žï¼š`tools/check_physics_logic.py`ï¼ˆç¦æ­¢è®­ç»ƒï¼Œä»…éªŒè¯é€»è¾‘è‡ªæ´½ï¼‰

### Assert 1ï¼šç›´çº¿ä¸å› æ¨ªå‘è¯¯å·®é™ v_capï¼ˆä¿å‘½çº§ï¼‰
- ç›´çº¿è·¯å¾„ä¸Šé€‰å®š sï¼ˆå¦‚æ€»é•¿ 1/3ï¼‰
- äººä¸ºè®¾ç½®æ¨ªå‘åå·®ï¼š`y_error = 0.5 * half_eps`
- è°ƒç”¨ `_compute_p4_pre_step_status()`
- æ–­è¨€ï¼š
  - `v_ratio_cap >= 0.95`
  - ä¸”ä¸Ž `y_error=0` æ—¶å·®å¼‚ `< 1e-3`

### Assert 2ï¼šæ‹è§’åˆ¹è½¦åŒ…ç»œç”Ÿæ•ˆï¼ˆä¿å‘½çº§ï¼‰
- æ–¹å½¢è·¯å¾„ä¸Šæ‰¾åˆ°ç¬¬ä¸€æ‹è§’ `turn_s`
- æ”¾åœ¨ `s = turn_s - d_test`ï¼ˆd_test å– 1~2 ä¸ª lookahead_spacingï¼‰
- è°ƒç”¨ `_compute_p4_pre_step_status()`
- æ–­è¨€ `speed_target_ratio` å·²è¢« `v_brake_turn/MAX_VEL` çº¦æŸåˆ°ä½ï¼ˆå…è®¸ 1e-6 è¯¯å·®ï¼‰

### Assert 3ï¼šç»ˆç‚¹åˆ¹è½¦åŒ…ç»œç”Ÿæ•ˆï¼ˆä¿å‘½çº§ï¼‰
- ç›´çº¿è·¯å¾„æŽ¥è¿‘ç»ˆç‚¹ï¼š`s = total_len - d_end_test`
- è®¡ç®— `v_brake_end = sqrt(2*MAX_ACC*d_end_test + EPS)`
- è°ƒç”¨ `_compute_p4_pre_step_status()`
- æ–­è¨€ `speed_target <= v_brake_end + 1e-6`

è„šæœ¬è¾“å‡ºå¿…é¡»æ‰“å°ï¼ˆä¾¿äºŽå®šä½é—®é¢˜ï¼‰ï¼š
- `dist_to_turn, turn_angle, v_ratio_cap, v_brake_turn_ratio, v_brake_end_ratio, speed_target_ratio`

ä¸¤æ¡ï¼ˆæˆ–ä¸‰æ¡ï¼‰æ–­è¨€å…¨è¿‡ï¼Œæ‰å…è®¸å¼€å§‹è®­ç»ƒã€‚

---

## 7) Definition of Doneï¼ˆå®Œæˆæ ‡å‡†ï¼‰
- `tools/check_physics_logic.py` å…¨éƒ¨æ–­è¨€é€šè¿‡ï¼Œä¸”æ—  NaN/Inf
- ç›´çº¿ï¼šè½¨è¿¹ä¸å†å› å¾®å°è¯¯å·®å‡ºçŽ°â€œè¶Šåè¶Šæ…¢â€ï¼Œå¹¶èƒ½åœ¨ç»ˆç‚¹å¤„åœä¸‹
- S åž‹ï¼šä¸å¼ºæŽ¨å†…åˆ‡åç½®ï¼Œèƒ½ç¨³å®šå‰è¿›å¹¶è¿‡å¼¯
- æ–¹å½¢ï¼šè¿›å¼¯å‰æå‰å‡é€Ÿï¼ˆåˆ¹è½¦åŒ…ç»œè§¦å‘ï¼‰ï¼Œç¬¬ä¸€æ‹è§’ä¸å†æå‰åˆ‡å†…å¯¼è‡´è¶Šç•Œ

---

## âš¡ ç‰¹åˆ«è¡¥å…… (Critical Additions)
åœ¨å®žçŽ°ä¸Šè¿°é€»è¾‘æ—¶ï¼Œè¯·åŠ¡å¿…å¤„ç†ä»¥ä¸‹ä¸¤ä¸ªè¾¹ç•Œæƒ…å†µï¼š
1. **æ•°å€¼ç¨³å®š**ï¼šæ‰€æœ‰åˆ†æ¯ï¼ˆå¦‚è®¡ç®—æ›²çŽ‡æ—¶çš„è·ç¦»ï¼‰å¿…é¡»åŠ  `EPS=1e-6`ï¼Œå¹¶é˜² NaN/Infï¼ˆä¾‹å¦‚ sqrt/cbrt å†…éƒ¨åŠ  EPSï¼Œwrap åŽ clampï¼‰ã€‚
2. **ç»ˆç‚¹åˆ¹è½¦**ï¼š`speed_target` å¿…é¡»åŒ…å« `v_brake_end = sqrt(2*MAX_ACC*dist_to_end + EPS)`ï¼Œç¡®ä¿ç›´çº¿ä»»åŠ¡èƒ½ç¨³ç¨³åœåœ¨ç»ˆç‚¹ï¼Œè€Œä¸æ˜¯å†²å‡ºè¾¹ç•Œã€‚

