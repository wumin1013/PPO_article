# P4–P8 规则栈瘦身与“基线-学习”拆分（Patch 05 / PhaseB 前必做）（v1.7.2）
版本日期：2025-12-30

目的：把现在混在一起的“遗留规则/保护逻辑/日志扫描”拆成**可开关、可追溯、可消融**的组件，避免你在 PhaseB 调参时陷入“到底是学出来的还是规则写死的”的泥潭。

---

## 0) 核心原则（只要这条不破，系统就可控）
任何逻辑都必须被归类到三类之一，并且在 Run Bundle 的 manifest 里可追溯：

1) **硬影响（Hard-impact）**：会改变动力学/终止条件/可达性分布  
2) **奖励塑形（Shaping）**：只影响学习驱动力，不改动力学  
3) **观测与日志（Observability）**：只提供信息与统计，默认不进入 reward

> 你现在“感觉冗余且难调”的根因，通常是 Hard-impact 与 Shaping 混在一起，且没有可靠的消融开关。

---

## 1) 需要被“拆开管理”的典型项目（以 P4/P6/P7/P8 为代表）
下面不是要求你删掉它们，而是要求你把它们变成“可控旋钮”。

### 1.1 Hard-impact（必须可开关，默认不改变旧行为）
- turning-feasible cap / speed cap 这类对执行速度上限的直接限制
- stall 终止（会改变 episode 结束分布）
- 任何对 action 的二次滤波或“隐藏二阶系统”（例如把 policy 输出先过平滑器再送入 KCM）

要求：
- 每一项都有清晰的 enable 开关（默认与当前一致）
- 每次 run 把开关状态写入 manifest（否则消融没意义）

### 1.2 Shaping（必须可开关，并能单独消融）
- 与拐角相关的奖励项（例如鼓励平滑、惩罚抖动、惩罚过早减速等）
- 与直线相关的奖励项（例如追求更高进给但不越界）

要求：
- Shaping 项不应偷偷改变动力学（例如在 reward 之外改 action）
- Shaping 的权重与启用状态必须落盘（写入 manifest）

### 1.3 Observability（建议尽快做足）
- 几何扫描产生的拐角距离、下一个转角、corner_phase 等信息
- corridor / 分段 mask（直线 vs 拐角）
- cap 触发比例、recovery 触发比例、done_reason 分布

要求：
- 默认不进入 reward（除非你明确打开）
- 必须能从 trace 或 eval summary 里读到（用于解释论文结果）

---

## 2) “基线-学习”拆分的落地方式（不破坏结构的最小方案）
你不需要大重构就能做到拆分，建议采用最小侵入原则：

- **保持现有默认路径**：不改你现在能跑通 P0 的那条路径
- **新增一个“策略学习模式”开关组合**：把 Hard-impact 中最可能遮蔽学习的部分逐项软化/关闭
- **新增一个“论文评测模式”配置**：固定 seed_eval 与 episode_set（如果实现），确保对比稳定

---

## 3) Detox 的验收（PhaseB 的前置门槛）
Detox 的 PASS 不是“性能更好”，而是“可控性更强”。

### 必须通过
- 在不改变默认行为的前提下，所有被拆分的开关都能被记录到 manifest  
- 用 baseline_ref（P0_L2）跑一次回归：指标不退化（保持 P0 通过）
- 随机抽取一个开关组合（例如关闭某个 Hard-impact 限制）：
  - 系统依然能跑通并落盘
  - 失败时失败原因清晰（例如 error 超阈值、stall 等），而不是无信息崩溃

---

## 4) 论文层面你会得到的直接收益
- 你能在论文里清楚说：哪些是硬约束（必须存在），哪些是学习得到的策略差异
- 你能做严格消融：关掉某个模块，拐角平滑/不退化如何变化
- 你能避免“调参调到最后不知道是谁在起作用”的典型科研悲剧

