# P0ï¼ˆv4ï¼‰ï¼šæ®‹å·®æ§åˆ¶è¯­ä¹‰å¯¹é½ + â€œåœç€æ‹¿åˆ†â€æ¸…é›¶ï¼ˆç»Ÿä¸€è„šæœ¬è‡ªéªŒè¯ + è‡ªåŠ¨éªŒæ”¶ + äººå®¡æ¸…å•ï¼‰

> è¿è¡Œæ–¹å¼ï¼šå…ˆæ¿€æ´» PPO è™šæ‹Ÿç¯å¢ƒ (`conda activate PPO`)ï¼Œç„¶ååœ¨ `PPO_project` ç›®å½•æ‰§è¡Œ `python` å‘½ä»¤ã€‚


> P0 ç›®æ ‡ï¼šå…ˆæŠŠç³»ç»Ÿâ€œæ•‘æ´»â€ã€‚åªè¦æ±‚ï¼š**ä¼šæ¨è¿›ã€ä¼šåˆ°ç»ˆç‚¹ã€ç›´çº¿è´´çº¿**ã€‚æ‹è§’å…è®¸å°–ï¼ˆP1 å†åœ†å¼§åŒ–ï¼‰ã€‚  
> æœ¬å¥—æµç¨‹ä½¿ç”¨ **å”¯ä¸€éªŒæ”¶å…¥å£è„šæœ¬**ï¼š`tools/acceptance_suite.py`ã€‚æ¯æ¬¡æ”¹å®Œä»£ç éƒ½èƒ½è·‘ smoke è‡ªéªŒè¯ï¼›è®­ç»ƒåè·‘ eval éªŒæ”¶ã€‚

---

## Step 0ï¼šå‡†å¤‡ä¸å›æ»šç‚¹ï¼ˆå¿…åšï¼‰
1) å»ºåˆ†æ”¯ï¼š`git checkout -b patch/P0_residual_progress_v4`  
2) å¤åˆ¶ configï¼š`configs/train_square.yaml -> configs/train_square_p0.yaml`  
3) ä¿ç•™ KCMï¼ˆç‰©ç†é“å¾‹ï¼‰å¼€å¯ï¼›å…³é—­å¼ºè§„åˆ™ï¼ˆè§ Step 3ï¼‰

---

## Step 1ï¼šåŠ¨åŠ›å­¦è¯­ä¹‰æ”¹ä¸º Residualï¼ˆå‚è€ƒåˆ‡å‘ + åŠ¨ä½œå¾®è°ƒï¼‰
æ–‡ä»¶ï¼š`PPO_project/src/environment/cnc_env.py`  
å‡½æ•°ï¼š`calculate_new_position(...)`

**ç¡¬è¦æ±‚**ï¼šä»â€œç§¯åˆ†å‹èˆªå‘â€æ”¹æˆâ€œå‚è€ƒåˆ‡å‘ + å°ä¿®æ­£â€ï¼š
- å‚è€ƒï¼š`theta_ref = _get_path_direction(current_position)`ï¼ˆP0 å…ˆç”¨æ®µåˆ‡å‘ï¼›P1 å†å‡çº§ lookahead LOSï¼‰
- æ‰§è¡Œï¼š`effective = theta_ref + omega_exec * dt`
- ä½ç§»æ²¿ `effective` ç§¯åˆ†
- `heading` ä¸å†ä¸»å¯¼çŠ¶æ€æ¼”åŒ–ï¼ˆæœ€å¤šç”¨äºæ—¥å¿—/è°ƒè¯•ï¼‰

---

## Step 2ï¼šå¥–åŠ±é‡æ„ï¼ˆç¡¬çº¦æŸï¼šåŸåœ°ä¸åŠ¨å¿…äºï¼‰
æ–‡ä»¶ï¼š`PPO_project/src/environment/reward.py`  
å‡½æ•°ï¼š`RewardCalculator.calculate_reward(...)`

**ç¡¬çº¦æŸï¼ˆä¼šè¢«è‡ªåŠ¨éªŒæ”¶æ£€æŸ¥ï¼‰**
- å›ºå®šåŠ¨ä½œï¼ˆå°¤å…¶ v=0ï¼‰ä¸åº”è·å¾—æ­£å›æŠ¥ï¼›stationary çš„å¹³å‡å›æŠ¥å¿…é¡»æ˜¾è‘—è´Ÿ  
- åªæœ‰ `progress_diff > 0` æ—¶ï¼Œæ€»å›æŠ¥æ‰å¯èƒ½ä¸ºæ­£

**æ¨èå½¢å¼ï¼ˆP0 æœ€ç¨³ï¼‰**
- `r_progress = + w_s * progress_diff`ï¼ˆä¸»å¯¼é¡¹ï¼‰
- `r_track = - w_e * (|e|/half_eps)^2`ï¼ˆçº¯æƒ©ç½šï¼Œæ— æ­£åŸºçº¿ï¼‰
- `r_dir   = - w_tau * tau^2`
- `r_time  = - w_t`ï¼ˆè¶³å¤Ÿå¤§ï¼‰
- `r_smooth` å¯ä»¥ä¿ç•™ä½†å…ˆå¼±

---

## Step 3ï¼šè®­ç»ƒæ—©æœŸå…³é—­å¼ºå¹²é¢„è§„åˆ™ï¼ˆåªç•™ KCMï¼‰
åœ¨ `configs/train_square_p0.yaml` ä¸­å…³é—­ï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼š
- corridor / speed cap / v_target_smoother / kappa_smoothing / recovery_cap ç­‰

---

# âœ… P0 è‡ªéªŒè¯ä¸è‡ªåŠ¨åŒ–éªŒæ”¶ï¼ˆç»Ÿä¸€è„šæœ¬ï¼‰

## A) æ”¹å®Œä»£ç ç«‹åˆ»è·‘ï¼šè‡ªéªŒè¯ï¼ˆæ— éœ€è®­ç»ƒï¼‰

**è‡ªåŠ¨ PASS æ¡ä»¶ï¼ˆè„šæœ¬å†…ï¼‰**
- stationary å¹³å‡å›æŠ¥æ˜¾è‘—è´Ÿï¼ˆé»˜è®¤ `< -20`ï¼‰
- stationary å¹³å‡ progress è¿‘ä¼¼ 0ï¼ˆé»˜è®¤ `< 0.02`ï¼‰
- æ—  NaN/Inf

## B) è®­ç»ƒåè·‘ï¼šè‡ªåŠ¨éªŒæ”¶ï¼ˆå…è®¸è¿›å…¥ P1 çš„é—¸é—¨ï¼‰
è®­ç»ƒï¼š

éªŒæ”¶ï¼š

**è‡ªåŠ¨ PASS æ¡ä»¶ï¼ˆè„šæœ¬å†…ï¼‰**
- `success_rate >= 0.80`
- `stall_rate <= 0.05`
- `mean_progress_final >= 0.95`
- `max_abs_contour_error <= half_epsilon`

> äº§ç‰©ï¼š`artifacts/p0_accept/summary.json`ï¼ˆå†…å« `passed=true`ï¼‰ï¼Œæ˜¯ P1 çš„ baselineã€‚

---

# ğŸ‘€ P0 å¿…è¦çš„äººä¸ºéªŒæ”¶æ¸…å•ï¼ˆå¿…è¦æ—¶ï¼‰
1) è½¨è¿¹èƒ½åˆ°ç»ˆç‚¹/é—­åˆä¸€åœˆï¼ˆæ‹è§’å°–å¯ä»¥ï¼‰  
2) ç›´çº¿æ®µé€Ÿåº¦ä¸æ˜¯é•¿æœŸè´´è¿‘ 0  
3) reward åˆ†è§£é‡Œ `progress` æ˜¯ä¸»å¯¼é¡¹ï¼ˆä¸é  tracking æ­£åŸºçº¿æŠ¬åˆ†ï¼‰
