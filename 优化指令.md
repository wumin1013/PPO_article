------

# 优化指令文档：J-NNC 运动规划算法重构与实验平台开发

背景：

我正在为 Robotics and Computer-Integrated Manufacturing (RCIM) 期刊准备一篇关于“融合捷度约束的端到端强化学习运动规划方法 (J-NNC)”的论文。

我现有的代码 (PPO最终版_改进.py) 是一个基础的训练脚本，虽然实现了核心算法，但缺乏模块化、对比实验、消融研究接口以及论文级的数据可视化功能。

任务目标：

请作为一名机器人控制与强化学习领域的资深工程师，根据以下具体要求，对我提供的代码进行彻底重构，并补全实验设计部分。

------

## 第一部分：代码架构与算法深度优化 (Refactoring & Optimization)

请对比论文中的 *Algorithm 1 (KCM)* 和 *Section 3 (模型设计)*，对代码进行以下修正：

1. **KCM 模块的独立封装与严格对齐**
   - **现状**：目前 `apply_kinematic_constraints` 散落在 `Env` 类中，且使用了 Numba。
   - **要求**：将 KCM 封装为独立的类或函数库。必须严格遵循论文 Algorithm 1 的两阶段逻辑：
     - *Phase 1 (Top-down)*: 从 $a_{raw}$ 到 $v_{target}$，依次经过 Clip(V), Clip(A), Clip(Jerk)。确保捷度 (Jerk) 具有最高优先级。
     - *Phase 2 (Bottom-up)*: 基于 $jerk_{final}$ 反算 $acc_t$ 和 $v_t$。
   - **修正**：确保代码中包含论文提到的 $a_{final} = [length_{prime}, \theta_{prime}]$ 的明确输出接口，以便后续分析 KCM 的干预度 (Intervention)。
2. **状态空间 (State Space) 的标准化**
   - **现状**：代码中的 `state` 维度为 12，但归一化逻辑较为简单。
   - **要求**：严格按照论文图 6 的定义检查特征。特别是“下一拐点转角”和“方向偏差角”的计算，必须确保几何计算的鲁棒性（处理极小线段或共线情况）。
3. **奖励函数 (Reward) 的配置化**
   - **现状**：奖励系数硬编码在 `calculate_reward` 中。
   - **要求**：将 $w_e, w_c, w_j$ 提取到配置文件或 `config` 字典中。这对于后续的消融实验（如移除 $r_j$）至关重要。
4. **工程化重构**
   - 引入 `Hydra` 或 `argparse` 进行参数管理（不再硬编码在 `run_training` 中）。
   - 将 `Env`, `Agent` (PPO), `KCM` 分离为不同的 Python 文件模块。

------

## 第二部分：实验设计与基线方法实现 (Experiment Design)

为了满足论文 *Section 4 (实验与结果)* 的要求，请在代码中增加以下实验模式：

1. 基线方法 (Baselines) 实现

   论文要求对比三种方法：

   - **J-NNC (Ours)**: 现有的完整模型。
   - **NNC (Baseline 1)**: 移除 KCM 模块中的“捷度约束层”，仅保留速度和加速度的硬裁剪 (Clip)。请实现一个 `NNC_Agent` 或在 Env 中增加 `enable_jerk_constraint=False` 的开关。
   - **Traditional (Baseline 2)**: 传统 S-Curve 加减速。由于无法连接真实 CNC，请实现一个基于 **S-形速度规划 (S-curve velocity profile)** 的纯几何规划器作为基准。它读取路径点，生成梯形加速度曲线（即 S 形速度），不使用神经网络。

2. 消融实验 (Ablation Study) 开关

   根据论文表 3，代码需要支持以下配置：

   - `--mode ablation_no_kcm`: 完全移除 KCM 模块（预期结果：任务失败）。
   - `--mode ablation_no_jerk_reward`: 保留 KCM，但将奖励函数中的 $w_j$ 设为 0（预期结果：捷度震荡）。

3. 测试路径生成器

   请创建一个 PathGenerator 类，支持生成论文图 7 中的两种路径：

   - **S-Shape**: 平滑的正弦曲线或 B 样条。
   - **Butterfly**: 也就是“蝶形路径”，包含尖锐的转角（曲率突变），用于测试鲁棒性。请提供具体的参数化生成代码。

------

## 第三部分：可视化交互系统 (Visualization & UI)

为了直观展示实验结果并方便调试，请基于 **Streamlit** 编写一个 `app.py`，实现以下功能：

1. **侧边栏控制面板**：
   - 选择模型：`J-NNC`, `NNC`, `Traditional`。
   - 选择路径：`S-Shape`, `Butterfly`。
   - 实验开关：`开启消融模式 (Disable Jerk Reward)`, `显示 KCM 干预度`。
   - 参数调整：`Max Velocity`, `Max Jerk` (实时调整以观察约束效果)。
2. **主视图可视化**（对应论文图 8, 9, 12）：
   - **2D 轨迹图**：绘制参考路径 $P_m$、左右边界 $P_l, P_r$ 和实际轨迹 $P_t$。
   - **运动学曲线 (Kinematics)**：三个并排子图，分别显示 速度 (Vel)、加速度 (Acc)、捷度 (Jerk) 随时间的变化。*重点：Jerk 曲线必须画出 Max Jerk 的限制阈值线（灰色虚线），以展示 J-NNC 的约束能力*。
   - **误差曲线**：显示轮廓误差 (Contour Error) 随时间的变化。
3. **指标统计表格**：
   - 实时计算并显示：加工时间、最大轮廓误差、平均轮廓误差、最大捷度。数据格式需与论文表 2 一致。

------

## 第四部分：数据导出接口 (Data Export)

为了制作论文中的高精矢量图（通常使用 Matplotlib 或 Origin），代码需要有导出功能：

- **CSV 导出**：在推理/测试结束后，自动保存一个 `experiment_data.csv`。
- **包含列**：`timestamp`, `pos_x`, `pos_y`, `ref_x`, `ref_y`, `velocity`, `acceleration`, `jerk`, `contour_error`, `kcm_intervention_level`。
- **用途**：用于生成论文图 9 (速度热力图) 和图 11 (KCM 干预度分析)。

------

**最终交付物清单：**

1. 重构后的模块化 Python 项目结构。
2. 包含 `S-curve` 基线和 `NNC` 基线的完整代码。
3. `app.py` (Streamlit 可视化代码)。
4. 用于生成论文插图的绘图脚本 (Plotting Utilities)。

------