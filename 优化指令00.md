------

# 优化指令 00：遗留代码重构与项目结构清洗 (最终合并版)

## 1. 背景与目标

目前项目存在两个维度的结构问题：

1. **根目录巨石应用：** 项目根目录下存在一个 `PPO最终版.py`，它将环境、算法、训练、绘图全部硬编码在一起，无法扩展。
2. **项目内文件散乱：** `PPO_project/` 文件夹内部堆积了大量辅助脚本、测试文件和工具类（如 `simulation_engine.py`, `rl_utils.py`），缺乏清晰的层级划分。

**目标：** 将所有代码归位到标准的 `src/` 架构中，清理根目录，仅保留入口文件和配置文件，并确保旧代码有备份。

------

## 2. 执行步骤

### 第一阶段：备份与巨石文件拆解

**对象：** 根目录下的 `PPO最终版.py`

1. **安全备份 (Safety First)**

   - 在项目根目录创建文件夹 `legacy_backup/`。
   - 将 `PPO最终版.py` 移动并重命名为 `legacy_backup/PPO_monolith_final_v1.py`。
   - *目的：确保重构失败时可随时回滚。*

2. 逻辑拆解与迁移 (Code Migration)

   请打开备份文件，将其中的代码块剪切并按以下映射关系填入 PPO_project/src/ 下的标准模块：

   | **原 PPO最终版.py 代码块**     | **目标位置 (在 PPO_project/src/ 下)** | **说明**                                                   |
   | ------------------------------ | ------------------------------------- | ---------------------------------------------------------- |
   | `@jit def apply_kinematic...`  | `environment/kinematics.py` (新建)    | 或保留在 `cnc_env.py` 顶部，建议独立                       |
   | `class Env`                    | `environment/cnc_env.py`              | 核心环境逻辑                                               |
   | `class ValueNet` / `PolicyNet` | `algorithms/ppo.py`                   | 神经网络定义                                               |
   | `class PPOContinuous`          | `algorithms/ppo.py`                   | 算法更新逻辑 (需移除 writer 相关硬编码)                    |
   | `class PaperMetrics`           | `utils/metrics.py` (新建)             | 专门负责论文指标统计                                       |
   | `def visualize_final_path`     | `utils/plotter.py` (新建)             | 绘图工具                                                   |
   | `class TrainingMonitor`        | **废弃**                              | 训练过程不再实时弹窗，由后续的 Dashboard (优化指令05) 接管 |
   | `def run_training`             | `../main.py` (重写)                   | 主程序逻辑移至新的入口文件                                 |

------

### 第二阶段：PPO_project 内部文件清洗

**对象：** `PPO_project/` 文件夹内的散乱文件

1. 建立标准目录结构

   在 PPO_project/ 下确保存在以下文件夹：

   - `tests/` : 存放所有测试脚本
   - `scripts/` : 存放独立工具/绘图脚本
   - `src/utils/` : 存放通用工具

2. **文件归位行动 (File Relocation)**

   | **文件名**              | **动作** | **目标位置 / 处理方式**         | **原因**                               |
   | ----------------------- | -------- | ------------------------------- | -------------------------------------- |
   | `rl_utils.py`           | **移动** | `src/utils/rl_utils.py`         | 工具类归入 utils 包                    |
   | `simulation_engine.py`  | **移动** | `src/environment/simulation.py` | 仿真核心归入 environment 模块          |
   | `test_logger.py`        | **移动** | `tests/test_logger.py`          | 测试代码与源码分离                     |
   | `test_perception.py`    | **移动** | `tests/test_perception.py`      | 同上                                   |
   | `plot_paper_figures.py` | **移动** | `scripts/paper_plotter.py`      | 独立绘图脚本归入 scripts               |
   | `run_streamlit_app.py`  | **删除** | (建议删除)                      | 以后直接用 `streamlit run app.py` 启动 |
   | `app.py`                | **保留** | `PPO_project/app.py`            | Web 应用入口，保留在根目录             |
   | `main.py`               | **重写** | `PPO_project/main.py`           | 训练入口，保留在根目录                 |

3. 修正引用路径 (Fix Imports)

   文件移动后，原有的 import 会失效，需要批量修正：

   - **在 `src/environment/cnc_env.py` 中：**

     Python

     ```
     # 修改前: import simulation_engine
     # 修改后:
     from src.environment import simulation
     from src.utils import rl_utils
     ```

   - **在 `tests/` 和 `scripts/` 的脚本头部添加路径黑魔法：**

     Python

     ```
     import sys
     import os
     # 将项目根目录添加到 python path，确保能 import src
     sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
     
     from src.environment.cnc_env import Env
     ```

------

### 第三阶段：统一入口与最终形态

重构完成后，您的 `PPO_project/` 目录结构应该如下所示（清爽版）：

Plaintext

```
PPO_project/
├── legacy_backup/       # [备份] 存放 PPO最终版.py 等旧文件
├── configs/             # [配置] yaml 配置文件
├── logs/                # [日志] 训练日志
├── saved_models/        # [模型] 权重保存
├── src/                 # [源码] 核心逻辑库
│   ├── algorithms/      # PPO, ValueNet 等
│   ├── environment/     # Env, Simulation, Kinematics
│   └── utils/           # Logger, Metrics, Plotter, RL_utils
├── tests/               # [测试] test_logger.py 等
├── scripts/             # [脚本] paper_plotter.py 等
├── main.py              # [入口] 统一训练入口
├── app.py               # [入口] 可视化看板入口
└── requirements.txt     # [依赖]
```

#### 关于新的 `main.py`

新的 `main.py` 不应包含任何具体类定义，它只负责“组装”：

1. 解析参数 (Args Parsing)。
2. 加载配置 (Config Loading)。
3. 实例化 `Env` 和 `Agent` (从 `src` 导入)。
4. 运行训练循环。

## 3. 自验证 (Self-Check)

完成上述所有操作后，请按顺序执行以下检查：

1. **路径检查：** 运行 `python tests/test_logger.py`。
   - *成功标准：* 不报错 `ModuleNotFoundError`，且能正确写入日志。
2. **训练冒烟测试：** 运行 `python main.py --config configs/default.yaml` (假设您已实现参数解析)。
   - *成功标准：* 环境初始化成功，模型开始训练，logs 目录下生成 CSV 文件，且**没有弹出 Matplotlib 窗口**。
3. **绘图脚本检查：** 运行 `python scripts/paper_plotter.py`。
   - *成功标准：* 能正确读取保存的数据并生成 PDF 图片。