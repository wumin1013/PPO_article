------

# 优化指令 05：全能可视化控制台 (Master Dashboard) [最终完整版]

## 1. 背景

用户需要一个集成了“工程监控”和“论文发表”的统一入口。

核心痛点解决：

1. **解耦与防卡死:** 以前直接在 Streamlit 中运行训练代码会导致界面卡死。现在的目标是将 UI 做成一个“遥控器”，负责生成命令并在后台发射训练进程。
2. **易用性升级:** 摒弃直接选择冰冷的配置文件，改为“面向任务”的操作流程（选轨迹 -> 定策略），并自动管理实验命名。

## 2. 任务

重写 `PPO_project/app.py`，并微调 `main.py` 的参数解析逻辑。

## 3. 执行要求

使用 `st.sidebar` 切换以下两种核心模式：

### 模式 A: 训练指挥塔 (Training Ops) —— *实验向导与异步发射*

**1. 实验设计向导 (Experiment Designer)** *[新增核心需求]*

此模块替代原有的“配置扫描”，提供更直观的交互：

- **步骤 1: 选择训练场景 (Trajectory Selection)**
  - 使用 `st.selectbox` 提供人类可读的选项，而非文件名。
  - **映射逻辑** (需在代码中维护字典):
    - "S-Shape Curve (S形曲线)" $\rightarrow$ 对应 `configs/s_shape.yaml`
    - "Butterfly Curve (蝴蝶曲线)" $\rightarrow$ 对应 `configs/butterfly.yaml`
- **步骤 2: 消融实验设置 (Ablation Settings)**
  - 提供一组 `st.checkbox` 供用户勾选（默认不勾选，即使用完整算法）：
    - [ ] **Disable KCM (禁用运动学约束)** $\rightarrow$ 对应命令行参数 `--use_kcm False`
    - [ ] **Disable Smoothness Reward (禁用平滑奖励)** $\rightarrow$ 对应命令行参数 `--use_smoothness_reward False`
- **步骤 3: 智能自动命名 (Auto-Naming)**
  - 根据上述选择，**实时自动生成** `experiment_name`，并在界面上显示（允许用户手动微调）。
  - **生成规则:** `exp_{Trajectory}_{AblationTags}_{Timestamp}`
  - *示例:* 用户选了 S形曲线并勾选了禁用 KCM $\rightarrow$ 自动生成 `exp_S_Shape_NoKCM_20251208`。
- **步骤 4: 高级选项 (Advanced)**
  - 使用 `st.expander` 折叠：
    - `Resume Checkpoint`: 输入框，用于填入断点续训的 `.pth` 路径。
    - `Force GPU`: 复选框。

**2. 后台发射器 (Process Launcher)** *[保留核心机制]*

- **机制:** 点击 **"🚀 Launch Training"** 按钮时，**严禁**直接 import 训练代码。

- **实现:** 使用 `subprocess.Popen` 构建并执行系统命令。

  - **命令组装逻辑:**

    Python

    ```
    # 伪代码示例
    cmd = [sys.executable, 'main.py']
    cmd.extend(['--config', config_path_mapped_from_selection])
    cmd.extend(['--experiment_name', auto_generated_name])
    
    # 动态追加消融参数 (覆盖配置文件中的默认值)
    if disable_kcm:
        cmd.extend(['--use_kcm', 'False'])
    if disable_reward:
        cmd.extend(['--use_smoothness_reward', 'False'])
    ```

  - *关键:* 必须使用**非阻塞模式**启动子进程。

- **状态管理:** 将子进程的 `PID` 存入 `st.session_state`，并在界面显示“任务运行中 (PID: xxxx)”。

**3. 非侵入式监控 (Passive Monitoring)** *[保留核心机制]*

- **逻辑:** Streamlit 不直接与训练进程通信，而是**只读**日志文件。
- **路径:** 根据生成的 `experiment_name`，锁定目标日志文件：`saved_models/{exp_name}/{timestamp}/logs/training_log.csv`。
- **绘图:**
  - 使用 `st.empty()` 占位符。
  - 创建定时循环（如 `time.sleep(2)` 或 `st.rerun` 机制），动态读取 CSV 最新几行。
  - 绘制 **Reward** 和 **Loss** 的动态折线图。
- **优势:** 即使关闭浏览器或刷新页面，后台训练不受影响；再次打开并选择对应实验名，曲线能自动接上。

------

### 模式 B: 科研展示 (Paper Mode) 

**1. 模型加载**

- **输入:** 浏览并加载 `saved_models/` 下生成的 `best_model.pth`。

**2. 功能 1: 批量鲁棒性评估 (Batch Evaluation)**

- **执行:** 点击按钮后，后端连续运行 20 次完整的轨迹跟踪实验。
- **统计:** 计算 RMSE (均方根误差)、Max Error (最大误差)、Mean Jerk (平均捷度) 的 **均值 (Mean)** 和 **标准差 (Std)**。
- **输出:** 生成一段标准的 **LaTeX 表格代码** 字符串，方便直接复制到论文中。

**3. 功能 2: 论文级绘图 (Paper Plots)**

- **Fig 1 (轨迹对比):** 绘制 Reference Path vs Actual Path。
  - *要求:* 必须画出公差带 (Tolerance Tube)，并对切弯处进行局部放大高亮。
- **Fig 2 (动力学曲线):** 绘制 Velocity, Acceleration, Jerk 随时间的变化曲线。
  - *要求:* 在图中画出红色的物理限制阈值线 (Limit Line)，证明约束满足。
- **导出:** 提供 **"Download .PDF"** 按钮，下载矢量图。

------

## 4. 配套修改提醒 (重要)

为了支持“实验向导”中的消融实验勾选功能，**必须**同步修改 `main.py` 的参数解析部分：

- 修改 main.py:

  确保 argparse 不仅接受 --config，还能接受 --use_kcm 和 --use_smoothness_reward 等具体参数。

- 覆盖逻辑:

  程序启动时应先读取 YAML 配置，再读取命令行参数。如果命令行参数存在（例如传入了 --use_kcm False），则覆盖 YAML 中的对应值。

------

## 5. 自验证 (验收标准)

1. **交互测试 (Wizard Test):**
   - 在界面选择 "Butterfly Curve"，勾选 "Disable KCM"。
   - **现象:** 实验名称输入框应自动变为类似 `exp_Butterfly_NoKCM_...` 的字样。
2. **启动测试 (Launch Test):**
   - 点击启动。
   - **检查:** 打开生成的 `saved_models/exp_Butterfly_NoKCM_.../config.yaml` (系统会自动保存一份副本)。
   - **断言:** 副本中的 `use_kcm` 字段应为 `False`，证明参数覆盖成功且任务已后台启动。
3. **监控与科研测试:**
   - 监控曲线正常跳动，实验结束后可在 Paper Mode 加载该模型生成图表。