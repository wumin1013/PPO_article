------

# 优化指令 06：系统终极加固与发布清洗 (Final Release Protocol)

## 1. 背景与目标

目前项目核心功能已就绪，但在作为最终交付物（Release）之前，还存在三个层面的不足：

1. **交互逻辑缺陷：** 控制台（Dashboard）目前只能记住“最后一次”启动的任务，无法同时管理并发实验，也缺少停止任务的手段。
2. **容错性不足：** 缺乏防御性编程，加载错误文件会导致程序崩溃。
3. **仓库不洁：** 项目中残留了大量开发过程中的备份文件、缓存文件和临时测试数据。

**目标：** 通过逻辑升级完成 Dashboard 的多任务管理功能，执行彻底的文件清洗，并按照严格标准进行最终自检，产出 **v1.0 发布版**。

------

## 2. 逻辑升级任务 (Logic Upgrades)

请打开 `PPO_project/app.py`，按照以下自然语言描述的逻辑修改代码结构：

### 任务 A：多进程管理系统的重构

**目标：** 将“单任务记录”升级为“任务列表队列”，并增加“终止”功能。

1. **状态存储结构变更：**
   - 找到初始化 Session State 的位置。
   - **操作：** 不再维护单一的 `last_launch` 变量。改为初始化一个名为 `running_processes` 的**空列表**，用于存储所有正在运行的任务信息。
2. **发射器逻辑变更 (Launcher Logic)：**
   - 找到 `launch_training_process` 函数中启动子进程成功后的位置。
   - **操作：** 不再覆盖旧状态。改为构建一个包含任务关键信息（PID、实验名称、启动时间、执行命令）的字典对象，并将该对象 **Append（追加）** 到 `running_processes` 列表中。
3. **侧边栏控制面板 (Sidebar Control)：**
   - 找到侧边栏渲染区域。
   - **操作：** 遍历 `running_processes` 列表。
   - **显示逻辑：** 为每个正在运行的任务创建一个折叠面板（Expander），显示其 PID 和启动时间。
   - **交互逻辑：** 在每个面板内增加一个 **“终止任务 (Kill)”** 按钮。
   - **触发逻辑：** 当点击按钮时，读取对应的 PID，调用系统底层信号（如 `os.kill`）强制结束进程，并从列表中移除该任务数据，最后刷新页面。

### 任务 B：防御性编程植入

**目标：** 杜绝因文件错误导致的系统崩溃（Crash）。

1. **模型加载保护：**
   - 找到“论文模式”下加载模型权重（Checkpoints）的逻辑段落。
   - **操作：** 使用 `try...except` 异常捕获结构包裹加载函数。
   - **处理逻辑：** 捕获所有潜在异常（如文件损坏、路径错误、反序列化失败）。一旦捕获异常，不要让程序中断，而是通过 Streamlit 的错误提示组件（`st.error`）在界面上优雅地告知用户“模型文件损坏或不匹配”，并停止后续的评估流程。

------

## 3. 深度清洗任务 (Deep Cleanup)

**目标：** 移除所有非必须文件，确保交付物的纯净。请在项目根目录手动或通过终端执行以下清理：

1. **移除编译缓存：**
   - 删除项目中所有层级下的 `__pycache__` 文件夹。
   - 删除所有 `.pyc` 格式文件。
2. **移除历史备份：**
   - **删除**根目录下的 `legacy_backup/` 文件夹（确认新代码稳定后，旧代码已无保留必要）。
   - **删除**根目录下可能存在的 `tests/` 生成的临时图片或日志。
3. **重置实验数据（可选）：**
   - 如果您希望交付一个全新的环境，请**清空** `saved_models/` 文件夹内的内容（保留文件夹本身）。
   - **删除** `logs/` 文件夹内所有 `.csv` 历史日志。
4. **移除开发IDE配置：**
   - 删除 `.idea/`、`.vscode/` 等编辑器生成的配置文件。

------

## 4. 全面自检清单 (Final Checklist)

在打包之前，请务必按顺序执行以下测试。如果所有项均为 ✅，则项目达到交付标准。

### 第一阶段：静态检查

- [ ] **目录纯净度：** 根目录下仅包含 `PPO_project/` 文件夹、`requirements.txt` 和说明文档。无散乱的 `.py` 脚本或备份文件夹。
- [ ] **依赖完备性：** 在一个新的虚拟环境中运行安装依赖命令，全程无报错。

### 第二阶段：动态交互测试 (Dashboard)

- [ ] **启动测试：** 运行 `streamlit run app.py`，Web 界面能在 3 秒内加载完毕。
- [ ] **并发管理测试 (关键)：**
  1. 连续启动两个不同名称的实验（例如 Experiment_A 和 Experiment_B）。
  2. **验证：** 侧边栏的“进行中任务”列表里应同时显示这两个任务。
- [ ] **终止测试 (关键)：**
  1. 点击 Experiment_A 的“终止”按钮。
  2. **验证：** Experiment_A 从列表消失，且在系统任务管理器中确认该 Python 进程已真正结束；同时 Experiment_B 仍正常运行。

### 第三阶段：核心功能验证

- [ ] **训练流测试：** 启动一个新训练，确认 `logs/training_log.csv` 文件被创建，且能实时写入数据（用 Excel 打开查看最新行）。
- [ ] **配置覆盖测试：** 在界面勾选“禁用 KCM”，启动后检查生成的配置文件副本，确认参数已被修改。
- [ ] **断点续训测试：** 中断一个运行中的训练，使用命令行参数 `--resume` 指向其存档点，确认程序能读取旧步数并继续运行。

### 第四阶段：科研产出验证

- [ ] **图表生成测试：** 进入“论文模式”，加载一个有效的模型文件。
- [ ] **结果验证：**
  1. 点击评估，LaTeX 表格代码成功生成。
  2. 点击下载，PDF 图片成功下载。
  3. 打开 PDF，确认包含了公差带（Tolerance Tube）和约束限制线。
- [ ] **容错测试：** 故意加载一个非 `.pth` 文件（如文本文件），系统应弹出红色错误提示，而不是直接崩溃报错。

------

## 5. 交付形态 (Final Artifact)

完成以上所有步骤后，您的代码库结构应如下所示（这是最完美的交付形态）：

Plaintext

```
Project_Root/
├── PPO_project/
│   ├── configs/             # [配置] 仅保留 yaml 配置文件
│   ├── src/                 # [源码] 纯净的源代码，无 pycache
│   ├── scripts/             # [脚本] 辅助绘图脚本
│   ├── app.py               # [入口] 升级后的可视化控制台
│   ├── main.py              # [入口] 训练主程序
│   └── requirements.txt     # [依赖] 依赖列表
└── README.md                # (可选) 项目说明
```

